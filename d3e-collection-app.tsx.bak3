import React, { useState, useEffect } from 'react';
import {
  FileText,
  Clipboard,
  FileSpreadsheet,
  Truck,
  Package,
  BarChart3,
  MapPin,
  Calendar,
  Clock,
  AlertCircle,
  CheckCircle2,
  XCircle,
  Search,
  Filter,
  Plus,
  Download,
  QrCode,
  FileEdit,
  TrendingUp,
  Weight,
  Euro,
  Users,
  Home,
  ChevronRight,
  Bell,
  Settings,
  X,
  Save,
  Building2,
  Phone,
  Mail,
  MapPinned,
  Sun,
  Moon,
  Monitor,
  Upload,
  File,
  Image,
  FileImage,
  FileType,
  Eye,
  Trash2,
  Info,
  Repeat,
  Layers,
  Split,
  Maximize2,
  Recycle,
  Leaf,
  ChevronDown,
} from 'lucide-react';
import { pickupRequestsApi } from './src/services/api';

// Types et interfaces
interface CaseFile {
  id: string;
  reference: string;
  client: string;
  site: string;
  status: 'diagnostic_pending' | 'quote_pending' | 'quote_approved' | 'in_collection' | 'in_progress' | 'completed';
  priority: 'high' | 'medium' | 'low';
  estimatedWeight: number;
  realWeight: number;
  estimatedValue: number;
  valeurEstimee?: number;
  valeurRevente?: number;
  createdAt: string;
  collectionDate?: string;
  notifications: number;
}

interface Lot {
  id: string;
  code: string;
  category: string;
  grade: 'A' | 'B' | 'C' | 'D';
  orientation: 'resale' | 'refurbishment' | 'dismantling' | 'waste';
  estimatedWeight: number;
  realWeight?: number;
  status: string;
  qrCode: string;
}

interface QuotationLine {
  id: string;
  type: 'service' | 'material' | 'package';
  description: string;
  unit: string;
  quantity: number;
  unitPrice: number;
  vatRate: number;
  total: number;
}

interface TransportOrder {
  id: string;
  type: string;
  transporter: string;
  vehicle: string;
  driver: string;
  status: 'planned' | 'in_progress' | 'completed' | 'delayed';
  plannedDate: string;
  documents: string[];
}

interface RequestFormData {
  clientName: string;
  siteName: string;
  siteAddress: string;
  contactName: string;
  contactFunction: string;
  contactPhone: string;
  contactEmail: string;
  description: string;
  mainCategory: string;
  estimatedVolume: string;
  valeurEstimee: string;
  valeurRevente: string;
  priority: 'high' | 'medium' | 'low';
  plannedVisitDate: string;
  accessNotes: string;
}

type ThemeMode = 'light' | 'dark' | 'auto';

const D3ECollectionApp = () => {
  // États principaux
  const [activeTab, setActiveTab] = useState<string>('dashboard');
  const [selectedCaseFile, setSelectedCaseFile] = useState<string>('CF-2025-001');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [isRequestPanelOpen, setIsRequestPanelOpen] = useState<boolean>(false);

  // État du thème
  const [themeMode, setThemeMode] = useState<ThemeMode>(() => {
    const saved = localStorage.getItem('themeMode');
    return (saved as ThemeMode) || 'auto';
  });
  const [isDark, setIsDark] = useState<boolean>(true);

  const [formData, setFormData] = useState<RequestFormData>({
    clientName: '',
    siteName: '',
    siteAddress: '',
    contactName: '',
    contactFunction: '',
    contactPhone: '',
    contactEmail: '',
    description: '',
    mainCategory: 'informatique',
    estimatedVolume: '',
    valeurEstimee: '',
    valeurRevente: '',
    priority: 'medium',
    plannedVisitDate: '',
    accessNotes: '',
  });

  // Fonction pour déterminer le thème basé sur l'heure (mode auto)
  const isNightTime = () => {
    const hour = new Date().getHours();
    // Nuit entre 19h et 7h
    return hour >= 19 || hour < 7;
  };

  // Effet pour gérer le thème
  useEffect(() => {
    const updateTheme = () => {
      let shouldBeDark = true;

      if (themeMode === 'light') {
        shouldBeDark = false;
      } else if (themeMode === 'dark') {
        shouldBeDark = true;
      } else if (themeMode === 'auto') {
        shouldBeDark = isNightTime();
      }

      setIsDark(shouldBeDark);
      localStorage.setItem('themeMode', themeMode);
    };

    updateTheme();

    // Si mode auto, vérifier toutes les minutes pour mettre à jour le thème
    if (themeMode === 'auto') {
      const interval = setInterval(updateTheme, 60000); // Vérifier chaque minute
      return () => clearInterval(interval);
    }
  }, [themeMode]);

  // Fonction pour changer de thème
  const cycleTheme = () => {
    setThemeMode((prev) => {
      if (prev === 'light') return 'dark';
      if (prev === 'dark') return 'auto';
      return 'light';
    });
  };

  // Fonction helper pour les classes de thème
  const bg = (darkClass: string, lightClass: string) => isDark ? darkClass : lightClass;
  const text = (darkClass: string, lightClass: string) => isDark ? darkClass : lightClass;
  const border = (darkClass: string, lightClass: string) => isDark ? darkClass : lightClass;

  // Classes préfabriquées pour les composants courants
  const cardClasses = `${bg('bg-slate-800/50', 'bg-white')} ${border('border-slate-700', 'border-gray-200')} border rounded-lg p-6`;
  const cardBgClasses = bg('bg-slate-800/50', 'bg-white');
  const cardBorderClasses = border('border-slate-700', 'border-gray-200');
  const inputClasses = `${bg('bg-slate-800', 'bg-gray-50')} ${border('border-slate-700', 'border-gray-300')} ${text('text-white', 'text-gray-900')} ${text('placeholder-slate-500', 'placeholder-gray-500')}`;
  const headingClasses = text('text-white', 'text-gray-900');
  const subTextClasses = text('text-slate-400', 'text-gray-600');
  const mutedTextClasses = text('text-slate-500', 'text-gray-500');

  // Obtenir l'icône du thème actuel
  const getThemeIcon = () => {
    if (themeMode === 'light') return Sun;
    if (themeMode === 'dark') return Moon;
    return Monitor;
  };

  const getThemeLabel = () => {
    if (themeMode === 'light') return 'Clair';
    if (themeMode === 'dark') return 'Sombre';
    return 'Auto';
  };

  const ThemeIcon = getThemeIcon();

  // État pour les dossiers chargés depuis l'API
  const [caseFiles, setCaseFiles] = useState<CaseFile[]>([]);
  const [isLoadingCaseFiles, setIsLoadingCaseFiles] = useState<boolean>(true);

  // État pour les détails du dossier sélectionné
  const [selectedCaseFileDetails, setSelectedCaseFileDetails] = useState<any>(null);
  const [isLoadingDetails, setIsLoadingDetails] = useState<boolean>(false);

  // État pour les utilisateurs (intervenants)
  const [users, setUsers] = useState<any[]>([]);
  const [isLoadingUsers, setIsLoadingUsers] = useState<boolean>(true);

  // États pour l'inventaire
  const [expandedLotId, setExpandedLotId] = useState<string | null>(null);
  const [selectedComponent, setSelectedComponent] = useState<any>(null);
  const [isComponentPanelOpen, setIsComponentPanelOpen] = useState<boolean>(false);

  // États pour le démantèlement
  const [isDismantlingPanelOpen, setIsDismantlingPanelOpen] = useState<boolean>(false);
  const [selectedLotForDismantling, setSelectedLotForDismantling] = useState<any>(null);
  const [dismantlingData, setDismantlingData] = useState<any[]>([]);

  // États pour les catégories et sous-catégories
  const [categories, setCategories] = useState<any[]>([]);
  const [isLoadingCategories, setIsLoadingCategories] = useState<boolean>(true);
  const [selectedCategoryId, setSelectedCategoryId] = useState<string>('');
  const [availableSubCategories, setAvailableSubCategories] = useState<any[]>([]);

  // Charger les dossiers depuis l'API au montage du composant
  useEffect(() => {
    const loadCaseFiles = async () => {
      try {
        setIsLoadingCaseFiles(true);
        // Demander tous les dossiers en spécifiant une limite élevée
        const response = await fetch('http://localhost:5000/api/case-files?limit=100');
        const result = await response.json();

        if (result.success && result.data.caseFiles) {
          // Transformer les données de l'API au format attendu par l'interface
          const transformedFiles: CaseFile[] = result.data.caseFiles.map((cf: any) => ({
            id: cf.id,
            reference: cf.reference,
            client: cf.request?.client?.raisonSociale || 'Client inconnu',
            site: cf.request?.site?.nom || 'Site inconnu',
            status: cf.statut,
            priority: cf.request?.priorite || 'medium',
            estimatedWeight: cf.poidsEstime || 0,
            realWeight: cf.poidsReel || 0,
            estimatedValue: cf.valeurTotale || 0,
            valeurEstimee: cf.request?.valeurEstimee || 0,
            valeurRevente: cf.request?.valeurRevente || 0,
            createdAt: new Date(cf.createdAt).toLocaleDateString('fr-FR'),
            collectionDate: cf.request?.plannedVisitAt
              ? new Date(cf.request.plannedVisitAt).toLocaleDateString('fr-FR')
              : undefined,
            notifications: 0, // À calculer selon la logique métier
          }));

          setCaseFiles(transformedFiles);

          // Sélectionner le premier dossier par défaut
          if (transformedFiles.length > 0 && !selectedCaseFile) {
            setSelectedCaseFile(transformedFiles[0].id);
          }
        }
      } catch (error) {
        console.error('Erreur lors du chargement des dossiers:', error);
        // En cas d'erreur, garder des données de démonstration
        setCaseFiles([
          {
            id: 'CF-2025-001',
            reference: 'CF-2025-001',
            client: 'TechCorp Industries',
            site: 'Site Paris 15',
            status: 'in_progress',
            priority: 'high',
            estimatedWeight: 2450,
            realWeight: 2580,
            estimatedValue: 18500,
            valeurEstimee: 12000,
            valeurRevente: 8500,
            createdAt: '2025-10-15',
            collectionDate: '2025-10-20',
            notifications: 2,
          },
        ]);
      } finally {
        setIsLoadingCaseFiles(false);
      }
    };

    loadCaseFiles();
  }, []); // Charger une seule fois au montage

  // Charger les catégories et sous-catégories
  useEffect(() => {
    const loadCategories = async () => {
      try {
        setIsLoadingCategories(true);
        const response = await fetch('http://localhost:5000/api/categories');
        const result = await response.json();

        if (result.success && result.data) {
          setCategories(result.data);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des catégories:', error);
      } finally {
        setIsLoadingCategories(false);
      }
    };

    loadCategories();
  }, []);

  // Charger les données de démantèlement depuis le fichier JSON
  useEffect(() => {
    const loadDismantlingData = async () => {
      try {
        const response = await fetch('/dementellement.json');
        const data = await response.json();
        setDismantlingData(data);
      } catch (error) {
        console.error('Erreur lors du chargement des données de démantèlement:', error);
      }
    };

    loadDismantlingData();
  }, []);

  // Mettre à jour les sous-catégories disponibles quand la catégorie change
  useEffect(() => {
    if (selectedCategoryId && categories.length > 0) {
      const category = categories.find(cat => cat.id === selectedCategoryId);
      if (category && category.subCategories) {
        setAvailableSubCategories(category.subCategories);
      } else {
        setAvailableSubCategories([]);
      }
    } else {
      setAvailableSubCategories([]);
    }
  }, [selectedCategoryId, categories]);

  // Initialiser la catégorie sélectionnée quand un composant est ouvert
  useEffect(() => {
    if (selectedComponent && selectedComponent.subCategory) {
      setSelectedCategoryId(selectedComponent.subCategory.categoryId);
    } else {
      setSelectedCategoryId('');
    }
  }, [selectedComponent]);

  // Charger les détails du dossier sélectionné
  useEffect(() => {
    const loadCaseFileDetails = async () => {
      if (!selectedCaseFile) return;

      try {
        setIsLoadingDetails(true);

        // Charger les détails complets depuis l'API avec l'endpoint getById qui inclut les composants
        const response = await fetch(`http://localhost:5000/api/case-files/${selectedCaseFile}`);
        const result = await response.json();

        if (result.success && result.data) {
          setSelectedCaseFileDetails(result.data);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des détails du dossier:', error);
      } finally {
        setIsLoadingDetails(false);
      }
    };

    loadCaseFileDetails();
  }, [selectedCaseFile, caseFiles]);

  // Charger les utilisateurs assignés au dossier sélectionné
  useEffect(() => {
    const loadAssignedUsers = async () => {
      if (!selectedCaseFile) {
        setUsers([]);
        return;
      }

      try {
        setIsLoadingUsers(true);
        const response = await fetch(`http://localhost:5000/api/case-files/${selectedCaseFile}/users`);
        const result = await response.json();

        if (result.success && result.data) {
          setUsers(result.data);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des utilisateurs assignés:', error);
        setUsers([]);
      } finally {
        setIsLoadingUsers(false);
      }
    };

    loadAssignedUsers();
  }, [selectedCaseFile]);

  // Données de démonstration pour les autres sections (à remplacer plus tard par l'API)

  const lots: Lot[] = [
    {
      id: 'LOT-001',
      code: 'LOT-001',
      category: 'Informatique - Unités centrales',
      grade: 'A',
      orientation: 'resale',
      estimatedWeight: 450,
      realWeight: 478,
      status: 'Réceptionné',
      qrCode: 'QR-LOT-001',
    },
    {
      id: 'LOT-002',
      code: 'LOT-002',
      category: 'Informatique - Écrans',
      grade: 'B',
      orientation: 'refurbishment',
      estimatedWeight: 680,
      realWeight: 695,
      status: 'En démantèlement',
      qrCode: 'QR-LOT-002',
    },
    {
      id: 'LOT-003',
      code: 'LOT-003',
      category: 'Câbles et accessoires',
      grade: 'C',
      orientation: 'dismantling',
      estimatedWeight: 320,
      realWeight: 310,
      status: 'Réceptionné',
      qrCode: 'QR-LOT-003',
    },
    {
      id: 'LOT-004',
      code: 'LOT-004',
      category: 'Serveurs et équipements réseau',
      grade: 'A',
      orientation: 'resale',
      estimatedWeight: 1000,
      realWeight: 1097,
      status: 'En stock',
      qrCode: 'QR-LOT-004',
    },
  ];

  const quotationLines: QuotationLine[] = [
    {
      id: '1',
      type: 'service',
      description: 'Transport - Forfait enlèvement',
      unit: 'forfait',
      quantity: 1,
      unitPrice: 450,
      vatRate: 20,
      total: 540,
    },
    {
      id: '2',
      type: 'service',
      description: 'Manutention - 2 manutentionnaires',
      unit: 'heure',
      quantity: 4,
      unitPrice: 45,
      vatRate: 20,
      total: 216,
    },
    {
      id: '3',
      type: 'material',
      description: 'Palettes EUR - Location',
      unit: 'pièce',
      quantity: 3,
      unitPrice: 15,
      vatRate: 20,
      total: 54,
    },
    {
      id: '4',
      type: 'service',
      description: 'Diagnostic et inventaire sur site',
      unit: 'forfait',
      quantity: 1,
      unitPrice: 350,
      vatRate: 20,
      total: 420,
    },
  ];

  const transportOrders: TransportOrder[] = [
    {
      id: 'TO-001',
      type: 'Enlèvement',
      transporter: 'Transport Express',
      vehicle: 'Camion 12T - AA-123-BB',
      driver: 'Jean Dupont',
      status: 'completed',
      plannedDate: '2025-10-20',
      documents: ['bon_pesée.pdf', 'bon_transport.pdf'],
    },
    {
      id: 'TO-002',
      type: 'Livraison entrepôt',
      transporter: 'Logistique Pro',
      vehicle: 'Camion 20T - CC-456-DD',
      driver: 'Marie Martin',
      status: 'in_progress',
      plannedDate: '2025-10-21',
      documents: ['ordre_transport.pdf'],
    },
  ];

  // Fonctions utilitaires
  const getStatusColor = (status: string): string => {
    const colors: { [key: string]: string } = {
      diagnostic_pending: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30',
      quote_pending: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
      quote_approved: 'bg-green-500/20 text-green-300 border-green-500/30',
      in_collection: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
      in_progress: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30',
      completed: 'bg-gray-500/20 text-gray-300 border-gray-500/30',
      planned: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
      delayed: 'bg-red-500/20 text-red-300 border-red-500/30',
    };
    return colors[status] || 'bg-gray-500/20 text-gray-300 border-gray-500/30';
  };

  const getStatusLabel = (status: string): string => {
    const labels: { [key: string]: string } = {
      diagnostic_pending: 'Diagnostic à planifier',
      quote_pending: 'Devis en attente',
      quote_approved: 'Devis approuvé',
      in_collection: 'En collecte',
      in_progress: 'En cours',
      completed: 'Terminé',
      planned: 'Planifié',
      delayed: 'Retardé',
    };
    return labels[status] || status;
  };

  const getGradeColor = (grade: string): string => {
    const colors: { [key: string]: string } = {
      A: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/40',
      B: 'bg-blue-500/20 text-blue-300 border-blue-500/40',
      C: 'bg-orange-500/20 text-orange-300 border-orange-500/40',
      D: 'bg-red-500/20 text-red-300 border-red-500/40',
    };
    return colors[grade] || 'bg-gray-500/20 text-gray-300 border-gray-500/40';
  };

  const getPriorityColor = (priority: string): string => {
    const colors: { [key: string]: string } = {
      high: 'text-red-400',
      medium: 'text-yellow-400',
      low: 'text-green-400',
    };
    return colors[priority] || 'text-gray-400';
  };

  // Gestion du formulaire
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmitRequest = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      // Appeler l'API via le service centralisé
      const result = await pickupRequestsApi.create(formData);

      if (result.success) {
        alert('Demande créée avec succès! Référence: ' + result.data.caseFile.reference);
        setIsRequestPanelOpen(false);
        // Réinitialiser le formulaire
        setFormData({
          clientName: '',
          siteName: '',
          siteAddress: '',
          contactName: '',
          contactFunction: '',
          contactPhone: '',
          contactEmail: '',
          description: '',
          mainCategory: 'informatique',
          estimatedVolume: '',
          valeurEstimee: '',
          valeurRevente: '',
          priority: 'medium',
          plannedVisitDate: '',
          accessNotes: '',
        });
        // Recharger la page pour voir la nouvelle demande
        window.location.reload();
      } else {
        alert('Erreur: ' + result.error);
      }
    } catch (error: any) {
      console.error('Erreur lors de la création de la demande:', error);
      alert('Erreur de connexion au serveur. Assurez-vous que le backend est démarré sur le port 5000.');
    }
  };

  // Composants d'onglets
  const DashboardTab = () => {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth(); // 0-11
    const [viewMode, setViewMode] = useState<'week' | 'month' | 'year'>('month');
    const [selectedPeriod, setSelectedPeriod] = useState<string>('current');

    // Calculer les KPI à partir des dossiers chargés
    const totalDemandes = caseFiles.length;
    const demandesEnCours = caseFiles.filter(cf => cf.status === 'in_progress' || cf.status === 'diagnosis').length;
    const demandesTerminees = caseFiles.filter(cf => cf.status === 'closed' || cf.status === 'completed').length;
    const poidsTotal = caseFiles.reduce((sum, cf) => sum + (cf.realWeight > 0 ? cf.realWeight : cf.estimatedWeight), 0);
    const valeurTotale = caseFiles.reduce((sum, cf) => sum + (cf.valeurEstimee || 0), 0);
    const valeurRevente = caseFiles.reduce((sum, cf) => sum + (cf.valeurRevente || 0), 0);

    // Données par période
    const dataByPeriod = {
      week: {
        current: [
          { period: 'S1', demandes: 5, poids: 580, valeur: 8700, recycle: 65, reemploi: 35 },
          { period: 'S2', demandes: 7, poids: 720, valeur: 10800, recycle: 58, reemploi: 42 },
          { period: 'S3', demandes: 6, poids: 650, valeur: 9750, recycle: 62, reemploi: 38 },
          { period: 'S4', demandes: 4, poids: 500, valeur: 7500, recycle: 70, reemploi: 30 },
        ],
        previous: [
          { period: 'S1', demandes: 4, poids: 520, valeur: 7800, recycle: 68, reemploi: 32 },
          { period: 'S2', demandes: 6, poids: 680, valeur: 10200, recycle: 60, reemploi: 40 },
          { period: 'S3', demandes: 5, poids: 590, valeur: 8850, recycle: 65, reemploi: 35 },
          { period: 'S4', demandes: 5, poids: 550, valeur: 8250, recycle: 63, reemploi: 37 },
        ]
      },
      month: {
        current: [
          { period: 'Jan', demandes: 12, poids: 1250, valeur: 18500, recycle: 65, reemploi: 35 },
          { period: 'Fév', demandes: 15, poids: 1680, valeur: 24200, recycle: 58, reemploi: 42 },
          { period: 'Mar', demandes: 18, poids: 2100, valeur: 31800, recycle: 55, reemploi: 45 },
          { period: 'Avr', demandes: 14, poids: 1420, valeur: 21000, recycle: 62, reemploi: 38 },
          { period: 'Mai', demandes: 20, poids: 2450, valeur: 36500, recycle: 52, reemploi: 48 },
          { period: 'Juin', demandes: 16, poids: 1890, valeur: 27400, recycle: 60, reemploi: 40 },
          { period: 'Juil', demandes: 13, poids: 1320, valeur: 19800, recycle: 68, reemploi: 32 },
          { period: 'Août', demandes: 10, poids: 980, valeur: 14500, recycle: 72, reemploi: 28 },
          { period: 'Sep', demandes: 19, poids: 2280, valeur: 34200, recycle: 54, reemploi: 46 },
          { period: 'Oct', demandes: 22, poids: 2650, valeur: 39800, recycle: 50, reemploi: 50 },
        ],
        previous: [
          { period: 'Jan', demandes: 10, poids: 1100, valeur: 16500, recycle: 70, reemploi: 30 },
          { period: 'Fév', demandes: 13, poids: 1450, valeur: 21750, recycle: 65, reemploi: 35 },
          { period: 'Mar', demandes: 16, poids: 1900, valeur: 28500, recycle: 60, reemploi: 40 },
          { period: 'Avr', demandes: 12, poids: 1250, valeur: 18750, recycle: 68, reemploi: 32 },
          { period: 'Mai', demandes: 18, poids: 2150, valeur: 32250, recycle: 58, reemploi: 42 },
          { period: 'Juin', demandes: 14, poids: 1650, valeur: 24750, recycle: 64, reemploi: 36 },
          { period: 'Juil', demandes: 11, poids: 1150, valeur: 17250, recycle: 72, reemploi: 28 },
          { period: 'Août', demandes: 9, poids: 880, valeur: 13200, recycle: 75, reemploi: 25 },
          { period: 'Sep', demandes: 17, poids: 2050, valeur: 30750, recycle: 59, reemploi: 41 },
          { period: 'Oct', demandes: 20, poids: 2400, valeur: 36000, recycle: 55, reemploi: 45 },
          { period: 'Nov', demandes: 15, poids: 1750, valeur: 26250, recycle: 62, reemploi: 38 },
          { period: 'Déc', demandes: 13, poids: 1380, valeur: 20700, recycle: 67, reemploi: 33 },
        ]
      },
      year: {
        current: [
          { period: '2021', demandes: 145, poids: 16500, valeur: 247500, recycle: 75, reemploi: 25 },
          { period: '2022', demandes: 168, poids: 18900, valeur: 283500, recycle: 70, reemploi: 30 },
          { period: '2023', demandes: 182, poids: 20800, valeur: 312000, recycle: 65, reemploi: 35 },
          { period: '2024', demandes: 195, poids: 22400, valeur: 336000, recycle: 60, reemploi: 40 },
          { period: '2025', demandes: 190, poids: 21500, valeur: 322500, recycle: 58, reemploi: 42 },
        ]
      }
    };

    // Sélectionner les données en fonction du mode de vue et de la période
    const getChartData = () => {
      if (viewMode === 'year') return dataByPeriod.year.current;
      return dataByPeriod[viewMode][selectedPeriod as 'current' | 'previous'];
    };

    const chartData = getChartData();
    const maxDemandes = Math.max(...chartData.map(m => m.demandes));
    const maxPoids = Math.max(...chartData.map(m => m.poids));

    // Calculer les statistiques d'orientation
    const totalRecycle = chartData.reduce((sum, d) => sum + d.recycle, 0) / chartData.length;
    const totalReemploi = chartData.reduce((sum, d) => sum + d.reemploi, 0) / chartData.length;

    // Obtenir le label de période
    const getPeriodLabel = () => {
      if (viewMode === 'week') return selectedPeriod === 'current' ? 'Mois en cours' : 'Mois dernier';
      if (viewMode === 'month') return selectedPeriod === 'current' ? `Année ${currentYear}` : `Année ${currentYear - 1}`;
      return 'Historique 5 ans';
    };

    return (
      <div className="space-y-6">
        {/* En-tête Dashboard avec sélecteur de période stylé */}
        <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-3">
          <div>
            <h2 className={`text-xl font-bold ${headingClasses} flex items-center gap-2`}>
              <BarChart3 className="w-6 h-6 text-cyan-400" />
              Dashboard - {getPeriodLabel()}
            </h2>
            <p className={`mt-0.5 text-xs ${subTextClasses}`}>Vue d'ensemble de l'activité et des performances</p>
          </div>

          {/* Sélecteur de vue stylé avec effet néon */}
          <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3">
            {/* Sélecteur de mode (Semaine/Mois/Année) */}
            <div className={`inline-flex items-center ${bg('bg-slate-800/50', 'bg-gray-100')} p-1 rounded-xl border ${border('border-slate-700', 'border-gray-200')} backdrop-blur-sm`}>
              <button
                onClick={() => setViewMode('week')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2 ${
                  viewMode === 'week'
                    ? `${bg('bg-gradient-to-r from-purple-600 to-purple-500', 'bg-purple-600')} text-white shadow-lg shadow-purple-500/50`
                    : `${text('text-slate-400', 'text-gray-600')} hover:${text('text-slate-300', 'text-gray-900')}`
                }`}
              >
                <Calendar className="w-4 h-4" />
                Semaine
              </button>
              <button
                onClick={() => setViewMode('month')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2 ${
                  viewMode === 'month'
                    ? `${bg('bg-gradient-to-r from-cyan-600 to-cyan-500', 'bg-cyan-600')} text-white shadow-lg shadow-cyan-500/50`
                    : `${text('text-slate-400', 'text-gray-600')} hover:${text('text-slate-300', 'text-gray-900')}`
                }`}
              >
                <Calendar className="w-4 h-4" />
                Mois
              </button>
              <button
                onClick={() => setViewMode('year')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2 ${
                  viewMode === 'year'
                    ? `${bg('bg-gradient-to-r from-emerald-600 to-emerald-500', 'bg-emerald-600')} text-white shadow-lg shadow-emerald-500/50`
                    : `${text('text-slate-400', 'text-gray-600')} hover:${text('text-slate-300', 'text-gray-900')}`
                }`}
              >
                <Calendar className="w-4 h-4" />
                Année
              </button>
            </div>

            {/* Sélecteur de période (En cours/Précédent) - Affiché uniquement pour semaine et mois */}
            {viewMode !== 'year' && (
              <div className={`inline-flex items-center ${bg('bg-slate-800/50', 'bg-gray-100')} p-1 rounded-xl border ${border('border-slate-700', 'border-gray-200')} backdrop-blur-sm`}>
                <button
                  onClick={() => setSelectedPeriod('current')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2 ${
                    selectedPeriod === 'current'
                      ? `${bg('bg-gradient-to-r from-blue-600 to-blue-500', 'bg-blue-600')} text-white shadow-lg shadow-blue-500/50`
                      : `${text('text-slate-400', 'text-gray-600')} hover:${text('text-slate-300', 'text-gray-900')}`
                  }`}
                >
                  <Clock className="w-4 h-4" />
                  En cours
                </button>
                <button
                  onClick={() => setSelectedPeriod('previous')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2 ${
                    selectedPeriod === 'previous'
                      ? `${bg('bg-gradient-to-r from-orange-600 to-orange-500', 'bg-orange-600')} text-white shadow-lg shadow-orange-500/50`
                      : `${text('text-slate-400', 'text-gray-600')} hover:${text('text-slate-300', 'text-gray-900')}`
                  }`}
                >
                  <ChevronRight className="w-4 h-4 rotate-180" />
                  Précédent
                </button>
              </div>
            )}
          </div>
        </div>

        {/* KPI Cards avec effet néon - Version compacte */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          {/* Total Demandes */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-3 relative overflow-hidden group hover:shadow-md hover:shadow-purple-500/20 transition-all`}>
            <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-500/10 to-transparent rounded-full blur-xl group-hover:scale-125 transition-transform"></div>
            <div className="relative">
              <div className="flex items-center gap-2 mb-1.5">
                <div className={`p-1.5 rounded ${bg('bg-purple-500/20', 'bg-purple-100')}`}>
                  <FileText className="w-3.5 h-3.5 text-purple-400" />
                </div>
                <div className={`text-[10px] ${subTextClasses} uppercase tracking-wide font-medium`}>Total</div>
              </div>
              <div className={`text-2xl font-bold ${text('text-purple-400', 'text-purple-600')} mb-0.5`}>{totalDemandes}</div>
              <div className={`text-[10px] ${subTextClasses}`}>Demandes</div>
              <div className="mt-1.5 flex items-center gap-1">
                <TrendingUp className="w-3 h-3 text-emerald-400" />
                <span className="text-emerald-400 text-[10px] font-medium">+12%</span>
              </div>
            </div>
          </div>

          {/* Demandes en cours */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-3 relative overflow-hidden group hover:shadow-md hover:shadow-blue-500/20 transition-all`}>
            <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-500/10 to-transparent rounded-full blur-xl group-hover:scale-125 transition-transform"></div>
            <div className="relative">
              <div className="flex items-center gap-2 mb-1.5">
                <div className={`p-1.5 rounded ${bg('bg-blue-500/20', 'bg-blue-100')}`}>
                  <Clock className="w-3.5 h-3.5 text-blue-400" />
                </div>
                <div className={`text-[10px] ${subTextClasses} uppercase tracking-wide font-medium`}>En cours</div>
              </div>
              <div className={`text-2xl font-bold ${text('text-blue-400', 'text-blue-600')} mb-0.5`}>{demandesEnCours}</div>
              <div className={`text-[10px] ${subTextClasses}`}>Actives</div>
              <div className="mt-1.5 flex items-center gap-1">
                <Clock className="w-3 h-3 text-blue-400" />
                <span className="text-blue-400 text-[10px] font-medium">En cours</span>
              </div>
            </div>
          </div>

          {/* Poids Total */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-3 relative overflow-hidden group hover:shadow-md hover:shadow-cyan-500/20 transition-all`}>
            <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-cyan-500/10 to-transparent rounded-full blur-xl group-hover:scale-125 transition-transform"></div>
            <div className="relative">
              <div className="flex items-center gap-2 mb-1.5">
                <div className={`p-1.5 rounded ${bg('bg-cyan-500/20', 'bg-cyan-100')}`}>
                  <Weight className="w-3.5 h-3.5 text-cyan-400" />
                </div>
                <div className={`text-[10px] ${subTextClasses} uppercase tracking-wide font-medium`}>Poids</div>
              </div>
              <div className={`text-2xl font-bold ${text('text-cyan-400', 'text-cyan-600')} mb-0.5`}>{(poidsTotal / 1000).toFixed(1)}</div>
              <div className={`text-[10px] ${subTextClasses}`}>Tonnes</div>
              <div className="mt-1.5 flex items-center gap-1">
                <TrendingUp className="w-3 h-3 text-emerald-400" />
                <span className="text-emerald-400 text-[10px] font-medium">+8%</span>
              </div>
            </div>
          </div>

          {/* Valeur Totale */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-3 relative overflow-hidden group hover:shadow-md hover:shadow-emerald-500/20 transition-all`}>
            <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-full blur-xl group-hover:scale-125 transition-transform"></div>
            <div className="relative">
              <div className="flex items-center gap-2 mb-1.5">
                <div className={`p-1.5 rounded ${bg('bg-emerald-500/20', 'bg-emerald-100')}`}>
                  <Euro className="w-3.5 h-3.5 text-emerald-400" />
                </div>
                <div className={`text-[10px] ${subTextClasses} uppercase tracking-wide font-medium`}>Valeur</div>
              </div>
              <div className={`text-2xl font-bold ${text('text-emerald-400', 'text-emerald-600')} mb-0.5`}>{valeurTotale.toLocaleString()} €</div>
              <div className={`text-[10px] ${subTextClasses}`}>Estimée</div>
              <div className={`text-xs ${subTextClasses} mt-1`}>
                Revente: {valeurRevente.toLocaleString()} €
              </div>
            </div>
          </div>
        </div>

        {/* Graphiques */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
          {/* Graphique Demandes */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm font-semibold ${headingClasses} flex items-center gap-2`}>
                <BarChart3 className="w-4 h-4 text-purple-400" />
                Demandes {viewMode === 'week' ? 'par semaine' : viewMode === 'month' ? 'par mois' : 'par année'}
              </h3>
              <div className={`px-2 py-0.5 rounded-lg ${bg('bg-purple-500/10', 'bg-purple-50')} text-purple-400 text-[10px] font-medium`}>
                {chartData.reduce((sum, m) => sum + m.demandes, 0)} total
              </div>
            </div>

            {/* Graphique en barres avec effet néon */}
            <div className="space-y-2">
              {chartData.map((data, index) => (
                <div key={data.period} className="flex items-center gap-2">
                  <div className={`w-10 text-[10px] ${subTextClasses} font-medium`}>{data.period}</div>
                  <div className="flex-1 relative h-6 rounded-lg overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                    <div
                      className="absolute inset-y-0 left-0 rounded-lg transition-all duration-700 ease-out"
                      style={{
                        width: `${(data.demandes / maxDemandes) * 100}%`,
                        background: isDark
                          ? 'linear-gradient(90deg, rgba(168, 85, 247, 0.8) 0%, rgba(139, 92, 246, 0.6) 100%)'
                          : 'linear-gradient(90deg, rgba(168, 85, 247, 0.9) 0%, rgba(139, 92, 246, 0.7) 100%)',
                        boxShadow: isDark ? '0 0 15px rgba(168, 85, 247, 0.4)' : '0 0 8px rgba(168, 85, 247, 0.3)',
                      }}
                    >
                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></div>
                    </div>
                    <div className={`absolute inset-0 flex items-center px-2 text-xs font-bold ${text('text-white', 'text-purple-900')}`}>
                      {data.demandes}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Graphique Poids collecté */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm font-semibold ${headingClasses} flex items-center gap-2`}>
                <Weight className="w-4 h-4 text-cyan-400" />
                Poids collecté (kg)
              </h3>
              <div className={`px-2 py-0.5 rounded-lg ${bg('bg-cyan-500/10', 'bg-cyan-50')} text-cyan-400 text-[10px] font-medium`}>
                {chartData.reduce((sum, m) => sum + m.poids, 0).toLocaleString()} kg
              </div>
            </div>

            {/* Graphique en barres avec effet néon cyan */}
            <div className="space-y-2">
              {chartData.map((data, index) => (
                <div key={data.period} className="flex items-center gap-2">
                  <div className={`w-10 text-[10px] ${subTextClasses} font-medium`}>{data.period}</div>
                  <div className="flex-1 relative h-6 rounded-lg overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                    <div
                      className="absolute inset-y-0 left-0 rounded-lg transition-all duration-700 ease-out"
                      style={{
                        width: `${(data.poids / maxPoids) * 100}%`,
                        background: isDark
                          ? 'linear-gradient(90deg, rgba(34, 211, 238, 0.8) 0%, rgba(6, 182, 212, 0.6) 100%)'
                          : 'linear-gradient(90deg, rgba(34, 211, 238, 0.9) 0%, rgba(6, 182, 212, 0.7) 100%)',
                        boxShadow: isDark ? '0 0 15px rgba(34, 211, 238, 0.4)' : '0 0 8px rgba(34, 211, 238, 0.3)',
                      }}
                    >
                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></div>
                    </div>
                    <div className={`absolute inset-0 flex items-center px-2 text-xs font-bold ${text('text-white', 'text-cyan-900')}`}>
                      {data.poids.toLocaleString()}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Nouveaux graphiques pertinents */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
          {/* Graphique Orientation (Recyclage vs Réemploi) */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm font-semibold ${headingClasses} flex items-center gap-2`}>
                <Repeat className="w-4 h-4 text-emerald-400" />
                Orientation
              </h3>
            </div>
            <div className="space-y-3">
              {/* Recyclage */}
              <div>
                <div className="flex items-center justify-between mb-1">
                  <span className={`text-[10px] ${subTextClasses} flex items-center gap-1`}>
                    <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                    Recyclage
                  </span>
                  <span className={`text-xs font-bold text-emerald-400`}>{totalRecycle.toFixed(0)}%</span>
                </div>
                <div className="relative h-4 rounded-full overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                  <div
                    className="absolute inset-y-0 left-0 rounded-full transition-all duration-700"
                    style={{
                      width: `${totalRecycle}%`,
                      background: 'linear-gradient(90deg, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.7) 100%)',
                      boxShadow: isDark ? '0 0 12px rgba(16, 185, 129, 0.5)' : '0 0 6px rgba(16, 185, 129, 0.3)',
                    }}
                  />
                </div>
              </div>
              {/* Réemploi */}
              <div>
                <div className="flex items-center justify-between mb-1">
                  <span className={`text-[10px] ${subTextClasses} flex items-center gap-1`}>
                    <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                    Réemploi
                  </span>
                  <span className={`text-xs font-bold text-amber-400`}>{totalReemploi.toFixed(0)}%</span>
                </div>
                <div className="relative h-4 rounded-full overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                  <div
                    className="absolute inset-y-0 left-0 rounded-full transition-all duration-700"
                    style={{
                      width: `${totalReemploi}%`,
                      background: 'linear-gradient(90deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.7) 100%)',
                      boxShadow: isDark ? '0 0 12px rgba(245, 158, 11, 0.5)' : '0 0 6px rgba(245, 158, 11, 0.3)',
                    }}
                  />
                </div>
              </div>
              {/* Total traité */}
              <div className={`pt-2 border-t ${border('border-slate-700/50', 'border-gray-200')}`}>
                <div className="flex items-center justify-between">
                  <span className={`text-[10px] ${subTextClasses}`}>Total traité</span>
                  <span className={`text-xs font-bold ${headingClasses}`}>100%</span>
                </div>
              </div>
            </div>
          </div>

          {/* Graphique Top Catégories */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm font-semibold ${headingClasses} flex items-center gap-2`}>
                <Layers className="w-4 h-4 text-blue-400" />
                Top Catégories
              </h3>
            </div>
            <div className="space-y-2">
              {[
                { name: 'Électroménager', percent: 35, color: 'rgba(59, 130, 246, 0.8)' },
                { name: 'Informatique', percent: 28, color: 'rgba(99, 102, 241, 0.8)' },
                { name: 'Téléphonie', percent: 20, color: 'rgba(139, 92, 246, 0.8)' },
                { name: 'Audiovisuel', percent: 17, color: 'rgba(168, 85, 247, 0.8)' },
              ].map((cat) => (
                <div key={cat.name}>
                  <div className="flex items-center justify-between mb-0.5">
                    <span className={`text-[10px] ${subTextClasses}`}>{cat.name}</span>
                    <span className={`text-[10px] font-medium ${headingClasses}`}>{cat.percent}%</span>
                  </div>
                  <div className="relative h-3 rounded-full overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                    <div
                      className="absolute inset-y-0 left-0 rounded-full transition-all duration-700"
                      style={{
                        width: `${cat.percent}%`,
                        background: cat.color,
                        boxShadow: isDark ? `0 0 10px ${cat.color}` : `0 0 5px ${cat.color}`,
                      }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Graphique Tendances */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-3">
              <h3 className={`text-sm font-semibold ${headingClasses} flex items-center gap-2`}>
                <TrendingUp className="w-4 h-4 text-rose-400" />
                Évolution
              </h3>
            </div>
            <div className="space-y-3">
              <div className={`p-2 rounded-lg ${bg('bg-emerald-500/10', 'bg-emerald-50')}`}>
                <div className="flex items-center justify-between mb-1">
                  <span className={`text-[10px] ${subTextClasses}`}>Demandes</span>
                  <div className="flex items-center gap-1">
                    <TrendingUp className="w-3 h-3 text-emerald-400" />
                    <span className="text-emerald-400 text-xs font-bold">+12%</span>
                  </div>
                </div>
                <div className={`text-xs ${text('text-emerald-300', 'text-emerald-700')}`}>vs période précédente</div>
              </div>
              <div className={`p-2 rounded-lg ${bg('bg-cyan-500/10', 'bg-cyan-50')}`}>
                <div className="flex items-center justify-between mb-1">
                  <span className={`text-[10px] ${subTextClasses}`}>Poids</span>
                  <div className="flex items-center gap-1">
                    <TrendingUp className="w-3 h-3 text-cyan-400" />
                    <span className="text-cyan-400 text-xs font-bold">+8%</span>
                  </div>
                </div>
                <div className={`text-xs ${text('text-cyan-300', 'text-cyan-700')}`}>vs période précédente</div>
              </div>
              <div className={`p-2 rounded-lg ${bg('bg-purple-500/10', 'bg-purple-50')}`}>
                <div className="flex items-center justify-between mb-1">
                  <span className={`text-[10px] ${subTextClasses}`}>Valeur</span>
                  <div className="flex items-center gap-1">
                    <TrendingUp className="w-3 h-3 text-purple-400" />
                    <span className="text-purple-400 text-xs font-bold">+15%</span>
                  </div>
                </div>
                <div className={`text-xs ${text('text-purple-300', 'text-purple-700')}`}>vs période précédente</div>
              </div>
            </div>
          </div>
        </div>

        {/* Statistiques supplémentaires */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          {/* Taux de complétion */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center gap-2 mb-2">
              <CheckCircle2 className="w-4 h-4 text-emerald-400" />
              <h3 className={`text-sm font-semibold ${headingClasses}`}>Taux de complétion</h3>
            </div>
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <span className={`text-[10px] ${subTextClasses}`}>Terminées</span>
                <span className={`text-[10px] font-medium ${headingClasses}`}>{demandesTerminees}</span>
              </div>
              <div className="relative h-2 rounded-full overflow-hidden" style={{ background: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(226, 232, 240, 1)' }}>
                <div
                  className="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-emerald-500 to-emerald-400"
                  style={{
                    width: `${totalDemandes > 0 ? (demandesTerminees / totalDemandes) * 100 : 0}%`,
                    boxShadow: '0 0 10px rgba(16, 185, 129, 0.5)'
                  }}
                ></div>
              </div>
              <div className={`text-xl font-bold ${text('text-emerald-400', 'text-emerald-600')}`}>
                {totalDemandes > 0 ? ((demandesTerminees / totalDemandes) * 100).toFixed(0) : 0}%
              </div>
            </div>
          </div>

          {/* Demandes prioritaires */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center gap-2 mb-2">
              <AlertCircle className="w-4 h-4 text-orange-400" />
              <h3 className={`text-sm font-semibold ${headingClasses}`}>Priorité haute</h3>
            </div>
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <span className={`text-[10px] ${subTextClasses}`}>Demandes urgentes</span>
                <span className={`text-[10px] font-medium ${headingClasses}`}>
                  {caseFiles.filter(cf => cf.priority === 'high').length}
                </span>
              </div>
              <div className={`text-xl font-bold ${text('text-orange-400', 'text-orange-600')}`}>
                {caseFiles.filter(cf => cf.priority === 'high').length}
              </div>
              <div className={`text-[10px] ${subTextClasses}`}>Nécessitent une attention immédiate</div>
            </div>
          </div>

          {/* Temps moyen */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-4`}>
            <div className="flex items-center gap-2 mb-2">
              <Clock className="w-4 h-4 text-blue-400" />
              <h3 className={`text-sm font-semibold ${headingClasses}`}>Temps moyen</h3>
            </div>
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <span className={`text-[10px] ${subTextClasses}`}>Traitement</span>
                <span className={`text-[10px] font-medium ${headingClasses}`}>~5.2 jours</span>
              </div>
              <div className={`text-xl font-bold ${text('text-blue-400', 'text-blue-600')}`}>
                5.2j
              </div>
              <div className={`text-[10px] ${subTextClasses}`}>De la demande à la clôture</div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Composant panneau de démantèlement
  const DismantlingPanel = () => {
    if (!selectedLotForDismantling) return null;

    const lot = selectedLotForDismantling;

    // Debug: afficher les infos du lot
    console.log('Lot sélectionné:', lot);
    console.log('Données de démantèlement:', dismantlingData);

    // Trouver la configuration de démantèlement
    let dismantlingConfig: any = null;
    let matchedSubCategory: any = null;

    // Étape 1: Trouver la catégorie principale correspondante
    const lotCategoryName = lot.categorieName?.toLowerCase() || '';
    console.log('Recherche catégorie pour:', lotCategoryName);

    const matchedCategory = dismantlingData.find((cat: any) => {
      const catLabel = cat.label?.toLowerCase() || '';
      return catLabel === lotCategoryName ||
             catLabel.includes(lotCategoryName) ||
             lotCategoryName.includes(catLabel);
    });

    console.log('Catégorie trouvée:', matchedCategory?.label);

    if (matchedCategory && matchedCategory.children) {
      // Étape 2: Essayer de trouver une sous-catégorie spécifique
      // On va regarder les noms des composants du lot pour trouver la meilleure correspondance
      const components = lot.components || [];

      if (components.length > 0) {
        // Prendre le nom du premier composant pour matcher
        const firstComponentName = components[0]?.nom?.toLowerCase() || '';
        console.log('Recherche sous-catégorie basée sur composant:', firstComponentName);

        const subCat = matchedCategory.children.find((sc: any) => {
          const scLabel = sc.label?.toLowerCase() || '';
          return firstComponentName.includes(scLabel) || scLabel.includes(firstComponentName);
        });

        if (subCat && subCat.dismantling) {
          dismantlingConfig = subCat.dismantling;
          matchedSubCategory = subCat;
          console.log('Configuration trouvée via composant:', subCat.label);
        }
      }

      // Si pas trouvé via composant, prendre la première sous-catégorie de la catégorie
      if (!dismantlingConfig && matchedCategory.children.length > 0) {
        const firstSubCat = matchedCategory.children[0];
        if (firstSubCat.dismantling) {
          dismantlingConfig = firstSubCat.dismantling;
          matchedSubCategory = firstSubCat;
          console.log('Utilisation de la première sous-catégorie:', firstSubCat.label);
        }
      }
    }

    // Fallback: si toujours rien trouvé, prendre n'importe quelle config
    if (!dismantlingConfig && dismantlingData.length > 0) {
      for (const category of dismantlingData) {
        if (category.children && category.children.length > 0) {
          const firstSubCat = category.children[0];
          if (firstSubCat.dismantling) {
            dismantlingConfig = firstSubCat.dismantling;
            matchedSubCategory = firstSubCat;
            console.log('Fallback - utilisation config par défaut:', firstSubCat.label);
            break;
          }
        }
      }
    }

    return (
      <>
        {/* Overlay */}
        <div
          className={`fixed inset-0 bg-black transition-opacity duration-300 z-40 ${
            isDismantlingPanelOpen ? 'opacity-50' : 'opacity-0 pointer-events-none'
          }`}
          onClick={() => setIsDismantlingPanelOpen(false)}
        ></div>

        {/* Panel coulissant */}
        <div
          className={`fixed top-0 right-0 h-full ${bg('bg-slate-900', 'bg-white')} shadow-2xl transform transition-transform duration-300 ease-in-out z-50 ${
            isDismantlingPanelOpen ? 'translate-x-0' : 'translate-x-full'
          }`}
          style={{ width: '80%' }}
        >
          <div className="h-full flex flex-col">
            {/* Header */}
            <div className={`${bg('bg-slate-800', 'bg-gray-50')} ${border('border-b-slate-700', 'border-b-gray-200')} border-b p-6`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className={`p-3 rounded-xl ${bg('bg-gradient-to-br from-purple-600 to-purple-500', 'bg-purple-100')} shadow-lg shadow-purple-500/30`}>
                    <Split className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h2 className={`text-2xl font-bold ${headingClasses}`}>Démantèlement du Lot</h2>
                    <p className={`text-sm ${subTextClasses} mt-1`}>
                      Éclatement en sous-composants • {lot.code}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setIsDismantlingPanelOpen(false)}
                  className={`p-2 rounded-lg ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} transition-colors`}
                >
                  <X className="w-6 h-6" />
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-6">
                {/* Info du lot */}
                <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-6`}>
                  <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center gap-2`}>
                    <Package className="w-5 h-5 text-purple-400" />
                    Information du Lot
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Code Lot</div>
                      <div className={`font-mono font-bold ${headingClasses}`}>{lot.code}</div>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Catégorie</div>
                      <div className={`font-medium ${headingClasses}`}>{lot.categorieName}</div>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Grade</div>
                      <span className={`inline-block px-2 py-1 rounded text-xs font-medium ${getGradeColor(lot.grade)}`}>
                        Grade {lot.grade}
                      </span>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Poids</div>
                      <div className={`font-bold ${headingClasses}`}>{lot.poidsReel || lot.poidsEstime || 0} kg</div>
                    </div>
                  </div>
                </div>

                {/* Configuration de démantèlement */}
                {dismantlingConfig ? (
                  <>
                    {/* Info de matching */}
                    {matchedSubCategory && (
                      <div className={`${bg('bg-blue-500/10', 'bg-blue-50')} ${border('border-blue-500/30', 'border-blue-200')} border rounded-xl p-4`}>
                        <div className="flex items-center gap-2">
                          <Info className="w-4 h-4 text-blue-400" />
                          <span className={`text-sm ${text('text-blue-300', 'text-blue-700')}`}>
                            Configuration: <strong>{matchedSubCategory.label}</strong>
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Sous-ensembles */}
                    <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-6`}>
                      <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center gap-2`}>
                        <Layers className="w-5 h-5 text-cyan-400" />
                        Sous-ensembles à Créer
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {dismantlingConfig.subassemblies.map((subassembly: string, index: number) => (
                          <div
                            key={index}
                            className={`p-4 rounded-lg ${bg('bg-slate-800/50', 'bg-gray-50')} ${border('border-slate-700', 'border-gray-200')} border ${bg('hover:bg-slate-700/50', 'hover:bg-gray-100')} transition-all cursor-pointer group`}
                          >
                            <div className="flex items-start gap-3">
                              <div className={`mt-0.5 w-6 h-6 rounded-full ${bg('bg-cyan-500/20', 'bg-cyan-100')} flex items-center justify-center flex-shrink-0`}>
                                <ChevronRight className="w-4 h-4 text-cyan-400" />
                              </div>
                              <div className="flex-1">
                                <div className={`font-medium ${headingClasses} group-hover:text-cyan-400 transition-colors`}>
                                  {subassembly}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Matières valorisables */}
                    {dismantlingConfig.valuable && dismantlingConfig.valuable.length > 0 && (
                      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-6`}>
                        <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center gap-2`}>
                          <TrendingUp className="w-5 h-5 text-emerald-400" />
                          Matières Valorisables
                        </h3>
                        <div className="flex flex-wrap gap-2">
                          {dismantlingConfig.valuable.map((material: string, index: number) => (
                            <span
                              key={index}
                              className={`px-3 py-2 rounded-lg ${bg('bg-emerald-500/20', 'bg-emerald-100')} ${border('border-emerald-500/30', 'border-emerald-200')} border text-emerald-400 text-sm font-medium`}
                            >
                              {material}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Matières dangereuses */}
                    {dismantlingConfig.hazardous && dismantlingConfig.hazardous.length > 0 && (
                      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-6`}>
                        <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center gap-2`}>
                          <AlertCircle className="w-5 h-5 text-red-400" />
                          Matières Dangereuses
                        </h3>
                        <div className="flex flex-wrap gap-2">
                          {dismantlingConfig.hazardous.map((hazard: string, index: number) => (
                            <span
                              key={index}
                              className={`px-3 py-2 rounded-lg ${bg('bg-red-500/20', 'bg-red-100')} ${border('border-red-500/30', 'border-red-200')} border text-red-400 text-sm font-medium`}
                            >
                              {hazard}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Notes */}
                    {dismantlingConfig.notes && (
                      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-xl p-6`}>
                        <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center gap-2`}>
                          <Info className="w-5 h-5 text-blue-400" />
                          Notes et Recommandations
                        </h3>
                        <p className={`${text('text-slate-300', 'text-gray-700')} leading-relaxed`}>
                          {dismantlingConfig.notes}
                        </p>
                      </div>
                    )}

                    {/* Actions */}
                    <div className="flex justify-end gap-3 pt-4">
                      <button
                        onClick={() => setIsDismantlingPanelOpen(false)}
                        className={`px-6 py-3 rounded-lg ${bg('bg-slate-700', 'bg-gray-200')} ${text('text-slate-300', 'text-gray-700')} hover:${bg('bg-slate-600', 'bg-gray-300')} transition-colors font-medium`}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={async () => {
                          // TODO: Implémenter la création des composants
                          alert('Fonctionnalité de création des composants à implémenter');
                          setIsDismantlingPanelOpen(false);
                        }}
                        className="px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-purple-500 text-white hover:from-purple-700 hover:to-purple-600 transition-all font-medium shadow-lg shadow-purple-500/30"
                      >
                        <div className="flex items-center gap-2">
                          <Split className="w-5 h-5" />
                          Créer les Composants
                        </div>
                      </button>
                    </div>
                  </>
                ) : (
                  <div className="flex flex-col items-center justify-center py-20">
                    <AlertCircle className="w-16 h-16 text-orange-400 mb-4" />
                    <h3 className={`text-lg font-semibold ${headingClasses} mb-2`}>
                      Configuration non disponible
                    </h3>
                    <p className={`text-sm ${subTextClasses} text-center max-w-md`}>
                      Aucune configuration de démantèlement n'est disponible pour cette sous-catégorie.
                      Veuillez vérifier la catégorie du lot.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </>
    );
  };

  const SynthesisTab = () => {
    const [isRulesOpen, setIsRulesOpen] = useState(false);

    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-xs ${subTextClasses}`}>Sélectionnez un dossier pour voir les détails</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const poidsReel = details.poidsReel || 0;
    const poidsEstime = details.poidsEstime || 0;
    const poidsDisplay = poidsReel > 0 ? (poidsReel / 1000).toFixed(2) : (poidsEstime / 1000).toFixed(2);
    const poidsVariation = poidsEstime > 0 && poidsReel > 0
      ? (((poidsReel - poidsEstime) / poidsEstime) * 100).toFixed(1)
      : '0';

    const nombreLots = details.lots?.length || 0;
    const valeurTotale = details.valeurTotale || 0;
    const lotsData = details.lots || [];

    const quotation = details.quotations && details.quotations.length > 0 ? details.quotations[0] : null;
    const devisStatut = quotation?.statut || 'pending';
    const devisDate = quotation?.createdAt ? new Date(quotation.createdAt).toLocaleDateString('fr-FR') : '-';

    return (
    <div className="space-y-4 overflow-hidden h-[calc(100vh-180px)]">
      {/* KPIs Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
        {/* Catégorie - PREMIÈRE CARD */}
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 transition-all duration-300`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-xs ${subTextClasses}`}>Catégorie</div>
            {(() => {
              const categorie = details.request?.categoriePrincipale?.toLowerCase() || 'autre';
              const IconComponent =
                categorie.includes('informatique') ? Monitor :
                categorie.includes('électroménager') || categorie.includes('electromenager') ? Home :
                categorie.includes('mobilier') || categorie.includes('meuble') ? Package :
                categorie.includes('équipement') || categorie.includes('equipement') ? Settings :
                Layers;
              return <IconComponent className="w-4 h-4 text-cyan-400" />;
            })()}
          </div>
          <div className={`text-xl font-bold ${text('text-slate-100', 'text-gray-900')}`}>
            {(() => {
              const categorie = details.request?.categoriePrincipale || 'Non définie';
              return categorie.charAt(0).toUpperCase() + categorie.slice(1);
            })()}
          </div>
          <div className={`text-xs ${mutedTextClasses} mt-1`}>
            {nombreLots} lot{nombreLots > 1 ? 's' : ''} concerné{nombreLots > 1 ? 's' : ''}
          </div>
        </div>

        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 transition-all duration-300`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-xs ${subTextClasses}`}>Poids Total</div>
            <Weight className="w-4 h-4 text-cyan-400" />
          </div>
          <div className={`text-2xl font-bold ${text('text-slate-100', 'text-gray-900')}`}>{poidsDisplay} T</div>
          <div className={`text-xs mt-1 ${parseFloat(poidsVariation) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
            {parseFloat(poidsVariation) >= 0 ? '+' : ''}{poidsVariation}% vs estimé
          </div>
        </div>

        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 transition-all duration-300`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-xs ${subTextClasses}`}>Nombre de Lots</div>
            <Package className="w-4 h-4 text-cyan-400" />
          </div>
          <div className={`text-2xl font-bold ${text('text-slate-100', 'text-gray-900')}`}>{nombreLots}</div>
          <div className={`text-xs ${mutedTextClasses} mt-1`}>
            {nombreLots > 0 ? 'Diagnostiqués' : 'Diagnostic à faire'}
          </div>
        </div>

        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 transition-all duration-300`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-xs ${subTextClasses}`}>Valeur Estimée</div>
            <Euro className="w-4 h-4 text-cyan-400" />
          </div>
          <div className={`text-2xl font-bold ${text('text-slate-100', 'text-gray-900')}`}>{valeurTotale.toLocaleString()} €</div>
          <div className={`text-xs ${mutedTextClasses} mt-1`}>Hors services</div>
        </div>

        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 transition-all duration-300`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-xs ${subTextClasses}`}>Statut Devis</div>
            <FileSpreadsheet className="w-4 h-4 text-cyan-400" />
          </div>
          <div className={`text-xl font-bold ${
            devisStatut === 'approved' ? 'text-emerald-400' :
            devisStatut === 'sent' ? 'text-cyan-400' :
            subTextClasses
          }`}>
            {devisStatut === 'approved' ? 'Approuvé' :
             devisStatut === 'sent' ? 'Envoyé' :
             'En attente'}
          </div>
          <div className={`text-xs ${mutedTextClasses} mt-1`}>Le {devisDate}</div>
        </div>
      </div>

      {/* Graphique Valeur Estimée vs Revente */}
      <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-6`}>
        <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-4 flex items-center`}>
          <TrendingUp className="w-4 h-4 mr-2 text-cyan-400" />
          Comparaison Financière
        </h3>

        <div className="space-y-4">
          {/* Valeur Totale Calculée (somme des lots) */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <Euro className="w-4 h-4 text-emerald-400" />
                <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Valeur Totale (Lots)</span>
              </div>
              <span className={`text-lg font-bold ${text('text-slate-100', 'text-gray-900')}`}>
                {valeurTotale.toLocaleString()} €
              </span>
            </div>
            <div className={`h-3 ${bg('bg-slate-800', 'bg-gray-200')} rounded-full overflow-hidden`}>
              <div
                className="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-700"
                style={{ width: `${Math.min(100, (valeurTotale / Math.max(valeurTotale || 1, details.request?.valeurEstimee || 1, details.request?.valeurRevente || 1)) * 100)}%` }}
              ></div>
            </div>
          </div>

          {/* Valeur Estimée Initiale */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <FileText className="w-4 h-4 text-blue-400" />
                <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Valeur Estimée (Demande)</span>
              </div>
              <span className={`text-lg font-bold ${text('text-slate-100', 'text-gray-900')}`}>
                {(details.request?.valeurEstimee || 0).toLocaleString()} €
              </span>
            </div>
            <div className={`h-3 ${bg('bg-slate-800', 'bg-gray-200')} rounded-full overflow-hidden`}>
              <div
                className="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-700"
                style={{ width: `${Math.min(100, ((details.request?.valeurEstimee || 0) / Math.max(valeurTotale || 1, details.request?.valeurEstimee || 1, details.request?.valeurRevente || 1)) * 100)}%` }}
              ></div>
            </div>
          </div>

          {/* Valeur Revente */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <TrendingUp className="w-4 h-4 text-cyan-400" />
                <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Valeur Revente</span>
              </div>
              <span className={`text-lg font-bold ${text('text-slate-100', 'text-gray-900')}`}>
                {(details.request?.valeurRevente || 0).toLocaleString()} €
              </span>
            </div>
            <div className={`h-3 ${bg('bg-slate-800', 'bg-gray-200')} rounded-full overflow-hidden`}>
              <div
                className="h-full bg-gradient-to-r from-cyan-500 to-cyan-400 transition-all duration-700"
                style={{ width: `${Math.min(100, ((details.request?.valeurRevente || 0) / Math.max(valeurTotale || 1, details.request?.valeurEstimee || 1, details.request?.valeurRevente || 1)) * 100)}%` }}
              ></div>
            </div>
          </div>

          {/* Écart entre Valeur Totale et Estimée */}
          <div className={`mt-4 p-3 ${bg('bg-slate-800', 'bg-gray-100')} rounded-lg`}>
            <div className="flex items-center justify-between">
              <span className={`text-xs ${text('text-slate-400', 'text-gray-600')}`}>Écart Totale vs Estimée</span>
              <span className={`text-sm font-semibold ${
                valeurTotale > (details.request?.valeurEstimee || 0)
                  ? 'text-emerald-400'
                  : 'text-red-400'
              }`}>
                {valeurTotale > (details.request?.valeurEstimee || 0) ? '+' : ''}
                {(valeurTotale - (details.request?.valeurEstimee || 0)).toLocaleString()} €
              </span>
            </div>
            <div className={`text-xs ${text('text-slate-500', 'text-gray-500')} mt-1`}>
              {valeurTotale > (details.request?.valeurEstimee || 0)
                ? 'Gain sur l\'estimation'
                : 'Perte sur l\'estimation'}
            </div>
          </div>
        </div>
      </div>

      {/* Estimation de valeur & filière optimale */}
      <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-6`}>
        <h3 className={`text-sm font-semibold ${text('text-slate-100', 'text-gray-900')} mb-6 flex items-center`}>
          <TrendingUp className="w-4 h-4 mr-2 text-cyan-400" />
          Estimation de Valeur & Filière Optimale
        </h3>
        {(() => {
          // Calcul du score éco-économique basé sur les lots
          const lotsData = details.lots || [];

          // Coefficients par filière et grade
          const coefficients = {
            reemploi: { A: 1.0, B: 0.8, C: 0.5, D: 0.2 },
            recyclage: { A: 0.6, B: 0.7, C: 0.8, D: 0.6 },
            traitement: { A: 0.3, B: 0.4, C: 0.5, D: 0.9 }
          };

          // Valeurs moyennes par kg selon la filière
          const valeurParKg = {
            reemploi: 15, // €/kg pour réemploi
            recyclage: 3, // €/kg pour recyclage matière
            traitement: -2 // €/kg coût de traitement (négatif)
          };

          // CO2 évité par kg selon la filière (kg CO2/kg matière)
          const co2ParKg = {
            reemploi: 8.5, // Fort impact positif
            recyclage: 4.2, // Impact moyen
            traitement: -1.5 // Impact négatif (incinération)
          };

          let totalPoids = 0;
          let scoreReemploi = 0;
          let scoreRecyclage = 0;
          let scoreTraitement = 0;

          // Calcul des scores pour chaque lot
          lotsData.forEach((lot: any) => {
            const poids = (lot.poidsReel || lot.poidsEstime || 0) / 1000; // Conversion en kg
            const grade = lot.grade || 'C';

            totalPoids += poids;

            // Score pondéré par le poids et le grade
            scoreReemploi += poids * (coefficients.reemploi[grade as keyof typeof coefficients.reemploi] || 0.5);
            scoreRecyclage += poids * (coefficients.recyclage[grade as keyof typeof coefficients.recyclage] || 0.7);
            scoreTraitement += poids * (coefficients.traitement[grade as keyof typeof coefficients.traitement] || 0.5);
          });

          // Normalisation des scores sur 100
          const maxScore = Math.max(scoreReemploi, scoreRecyclage, scoreTraitement) || 1;
          const scoreReemploiNorm = Math.round((scoreReemploi / maxScore) * 100);
          const scoreRecyclageNorm = Math.round((scoreRecyclage / maxScore) * 100);
          const scoreTraitementNorm = Math.round((scoreTraitement / maxScore) * 100);

          // Détermination de la filière recommandée
          const recommandation =
            scoreReemploiNorm >= scoreRecyclageNorm && scoreReemploiNorm >= scoreTraitementNorm ? 'reemploi' :
            scoreRecyclageNorm >= scoreTraitementNorm ? 'recyclage' : 'traitement';

          const scoreRecommande =
            recommandation === 'reemploi' ? scoreReemploiNorm :
            recommandation === 'recyclage' ? scoreRecyclageNorm : scoreTraitementNorm;

          // Calcul de la valeur estimée et CO2 évité
          const valeurEstimee = Math.round(totalPoids * valeurParKg[recommandation]);
          const co2Evite = Math.round(totalPoids * co2ParKg[recommandation] * 10) / 10;

          // Couleurs selon la recommandation
          const couleurRecommandation = {
            reemploi: { text: 'text-emerald-400', bg: 'bg-emerald-500', border: 'border-emerald-400', shadow: 'shadow-emerald-500' },
            recyclage: { text: 'text-cyan-400', bg: 'bg-cyan-500', border: 'border-cyan-400', shadow: 'shadow-cyan-500' },
            traitement: { text: 'text-orange-400', bg: 'bg-orange-500', border: 'border-orange-400', shadow: 'shadow-orange-500' }
          };

          const couleurs = couleurRecommandation[recommandation];

          return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Jauge principale - Recommandation */}
              <div className="lg:col-span-2">
                <div className={`${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-xl p-6`}>
                  <div className="flex items-center justify-between mb-4">
                    <h4 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')}`}>
                      Filière Recommandée: {recommandation === 'reemploi' ? 'Réemploi' : recommandation === 'recyclage' ? 'Recyclage Matière' : 'Traitement'}
                    </h4>
                    <div className={`text-2xl font-bold ${couleurs.text}`}>
                      {scoreRecommande}/100
                    </div>
                  </div>

                  {/* Jauge visuelle */}
                  <div className={`relative h-8 ${bg('bg-slate-900', 'bg-gray-200')} rounded-full overflow-hidden mb-4`}>
                    <div
                      className={`absolute top-0 left-0 h-full ${couleurs.bg} transition-all duration-1000 ease-out`}
                      style={{ width: `${scoreRecommande}%` }}
                    >
                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                    </div>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-xs font-semibold text-white drop-shadow-lg">
                        Score Éco-Économique
                      </span>
                    </div>
                  </div>

                  {/* Comparaison des 3 filières */}
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Recycle className="w-4 h-4 text-emerald-400" />
                        <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Réemploi</span>
                      </div>
                      <div className="flex-1 mx-4">
                        <div className={`h-2 ${bg('bg-slate-900', 'bg-gray-200')} rounded-full overflow-hidden`}>
                          <div
                            className="h-full bg-emerald-500 transition-all duration-700"
                            style={{ width: `${scoreReemploiNorm}%` }}
                          ></div>
                        </div>
                      </div>
                      <span className={`text-sm font-medium ${text('text-slate-200', 'text-gray-800')} w-12 text-right`}>{scoreReemploiNorm}</span>
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Package className="w-4 h-4 text-cyan-400" />
                        <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Recyclage</span>
                      </div>
                      <div className="flex-1 mx-4">
                        <div className={`h-2 ${bg('bg-slate-900', 'bg-gray-200')} rounded-full overflow-hidden`}>
                          <div
                            className="h-full bg-cyan-500 transition-all duration-700"
                            style={{ width: `${scoreRecyclageNorm}%` }}
                          ></div>
                        </div>
                      </div>
                      <span className={`text-sm font-medium ${text('text-slate-200', 'text-gray-800')} w-12 text-right`}>{scoreRecyclageNorm}</span>
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Trash2 className="w-4 h-4 text-orange-400" />
                        <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>Traitement</span>
                      </div>
                      <div className="flex-1 mx-4">
                        <div className={`h-2 ${bg('bg-slate-900', 'bg-gray-200')} rounded-full overflow-hidden`}>
                          <div
                            className="h-full bg-orange-500 transition-all duration-700"
                            style={{ width: `${scoreTraitementNorm}%` }}
                          ></div>
                        </div>
                      </div>
                      <span className={`text-sm font-medium ${text('text-slate-200', 'text-gray-800')} w-12 text-right`}>{scoreTraitementNorm}</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Indicateurs financiers et environnementaux */}
              <div className="space-y-4">
                {/* Valeur estimée */}
                <div className={`${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-xl p-4`}>
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
                      <Euro className="w-5 h-5 text-emerald-400" />
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses}`}>Valeur Estimée</div>
                      <div className={`text-2xl font-bold ${valeurEstimee >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                        {valeurEstimee >= 0 ? '+' : ''}{valeurEstimee.toLocaleString()} €
                      </div>
                    </div>
                  </div>
                  <div className={`text-xs ${mutedTextClasses}`}>
                    Basé sur {totalPoids.toFixed(1)} kg de matériel
                  </div>
                </div>

                {/* CO2 évité */}
                <div className={`${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-xl p-4`}>
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                      <Leaf className="w-5 h-5 text-green-400" />
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses}`}>CO₂ Évité</div>
                      <div className={`text-2xl font-bold ${co2Evite >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {co2Evite >= 0 ? '+' : ''}{co2Evite} kg
                      </div>
                    </div>
                  </div>
                  <div className={`text-xs ${mutedTextClasses}`}>
                    Impact environnemental positif
                  </div>
                </div>
              </div>
            </div>
          );
        })()}

        {/* Règles de calcul visibles - avec animation */}
        <div className="mt-6">
          <button
            onClick={() => setIsRulesOpen(!isRulesOpen)}
            className={`w-full cursor-pointer text-sm font-medium ${subTextClasses} hover:${text('text-slate-300', 'text-gray-700')} transition-colors flex items-center gap-2`}
          >
            <Info className="w-4 h-4" />
            <span>Voir les règles de calcul et coefficients</span>
            <ChevronDown
              className={`w-4 h-4 ml-auto transition-transform duration-300 ${
                isRulesOpen ? 'rotate-180' : ''
              }`}
            />
          </button>
          <div
            className={`overflow-hidden transition-all duration-500 ease-in-out ${
              isRulesOpen ? 'max-h-[800px] opacity-100 mt-4' : 'max-h-0 opacity-0'
            }`}
          >
            <div className={`p-4 ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-lg`}>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <div>
                <h5 className={`font-semibold ${text('text-slate-200', 'text-gray-800')} mb-2`}>Coefficients par Grade</h5>
                <table className="w-full">
                  <thead>
                    <tr className={subTextClasses}>
                      <th className="text-left py-1">Grade</th>
                      <th className="text-center py-1">Réemploi</th>
                      <th className="text-center py-1">Recyclage</th>
                      <th className="text-center py-1">Traitement</th>
                    </tr>
                  </thead>
                  <tbody className={text('text-slate-300', 'text-gray-700')}>
                    <tr>
                      <td className="py-1">A (Excellent)</td>
                      <td className="text-center text-emerald-400 font-semibold">1.0</td>
                      <td className="text-center">0.6</td>
                      <td className="text-center">0.3</td>
                    </tr>
                    <tr>
                      <td className="py-1">B (Bon)</td>
                      <td className="text-center text-emerald-400 font-semibold">0.8</td>
                      <td className="text-center">0.7</td>
                      <td className="text-center">0.4</td>
                    </tr>
                    <tr>
                      <td className="py-1">C (Moyen)</td>
                      <td className="text-center">0.5</td>
                      <td className="text-center text-cyan-400 font-semibold">0.8</td>
                      <td className="text-center">0.5</td>
                    </tr>
                    <tr>
                      <td className="py-1">D (Mauvais)</td>
                      <td className="text-center">0.2</td>
                      <td className="text-center">0.6</td>
                      <td className="text-center text-orange-400 font-semibold">0.9</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div>
                <h5 className={`font-semibold ${text('text-slate-200', 'text-gray-800')} mb-2`}>Valeur par kg</h5>
                <ul className={`space-y-1 ${text('text-slate-300', 'text-gray-700')}`}>
                  <li className="flex justify-between">
                    <span>Réemploi:</span>
                    <span className="font-semibold text-emerald-400">+15 €/kg</span>
                  </li>
                  <li className="flex justify-between">
                    <span>Recyclage:</span>
                    <span className="font-semibold text-cyan-400">+3 €/kg</span>
                  </li>
                  <li className="flex justify-between">
                    <span>Traitement:</span>
                    <span className="font-semibold text-orange-400">-2 €/kg</span>
                  </li>
                </ul>
              </div>
              <div>
                <h5 className={`font-semibold ${text('text-slate-200', 'text-gray-800')} mb-2`}>Impact CO₂ par kg</h5>
                <ul className={`space-y-1 ${text('text-slate-300', 'text-gray-700')}`}>
                  <li className="flex justify-between">
                    <span>Réemploi:</span>
                    <span className="font-semibold text-green-400">+8.5 kg CO₂</span>
                  </li>
                  <li className="flex justify-between">
                    <span>Recyclage:</span>
                    <span className="font-semibold text-green-400">+4.2 kg CO₂</span>
                  </li>
                  <li className="flex justify-between">
                    <span>Traitement:</span>
                    <span className="font-semibold text-red-400">-1.5 kg CO₂</span>
                  </li>
                </ul>
              </div>
            </div>
            <p className={`mt-3 text-xs ${subTextClasses} italic`}>
              * Le score est calculé en pondérant chaque lot par son poids et son grade, puis normalisé sur 100.
              La filière recommandée est celle qui obtient le meilleur score éco-économique.
            </p>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content: 12-column grid layout - NO SCROLLBAR */}
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-12 gap-4 h-[calc(100%-250px)]">
        {/* Calendar - 3/12 sur 27" (1/4), 1/2 sur iPad */}
        <div className="md:col-span-1 xl:col-span-3">
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 h-full flex flex-col`}>
          <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-3 flex items-center flex-shrink-0`}>
            <Calendar className="w-4 h-4 mr-2 text-cyan-400" />
            Calendrier
          </h3>
          <div className="flex-1 overflow-y-auto pr-1">
          {(() => {
            // Collecter tous les événements du dossier avec leurs couleurs
            const events: Array<{ date: Date; label: string; color: string; icon: any }> = [];

            // 1. Demande (toujours présent)
            if (details.createdAt) {
              events.push({
                date: new Date(details.createdAt),
                label: 'Demande',
                color: 'emerald',
                icon: FileText
              });
            }

            // 2. Diagnostic
            if (details.diagnosis?.dateVisite) {
              events.push({
                date: new Date(details.diagnosis.dateVisite),
                label: 'Diagnostic',
                color: 'blue',
                icon: Clipboard
              });
            } else if (details.request?.plannedVisitAt) {
              events.push({
                date: new Date(details.request.plannedVisitAt),
                label: 'Visite prévue',
                color: 'cyan',
                icon: Clipboard
              });
            }

            // 3. Devis
            if (quotation?.createdAt) {
              events.push({
                date: new Date(quotation.createdAt),
                label: 'Devis',
                color: quotation.statut === 'approved' ? 'emerald' : 'yellow',
                icon: FileSpreadsheet
              });
            }

            // 4. Collecte
            if (details.request?.plannedVisitAt && details.statut !== 'diagnostic_pending') {
              events.push({
                date: new Date(details.request.plannedVisitAt),
                label: 'Collecte',
                color: 'orange',
                icon: Truck
              });
            }

            // 5. Clôture
            if (details.closedAt) {
              events.push({
                date: new Date(details.closedAt),
                label: 'Clôturé',
                color: 'emerald',
                icon: CheckCircle2
              });
            }

            // Déterminer le mois à afficher (mois de la date de création)
            const displayDate = details.createdAt ? new Date(details.createdAt) : new Date();
            const currentMonth = displayDate.getMonth();
            const currentYear = displayDate.getFullYear();

            // Calculer les jours du mois
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayWeekday = firstDayOfMonth.getDay(); // 0 = dimanche

            // Ajuster pour que lundi soit le premier jour (0 = lundi)
            const startOffset = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;

            // Créer un mapping des événements par jour
            const eventsByDay: { [day: number]: Array<{ label: string; color: string; icon: any }> } = {};
            events.forEach(event => {
              if (event.date.getMonth() === currentMonth && event.date.getFullYear() === currentYear) {
                const day = event.date.getDate();
                if (!eventsByDay[day]) {
                  eventsByDay[day] = [];
                }
                eventsByDay[day].push(event);
              }
            });

            // Noms des jours de la semaine
            const weekDays = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            // Nom du mois
            const monthNames = [
              'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
              'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];

            // Fonction pour obtenir la classe de couleur
            const getColorClasses = (color: string) => {
              switch (color) {
                case 'emerald':
                  return {
                    bg: 'bg-emerald-500',
                    ring: 'ring-emerald-400',
                    text: 'text-emerald-400'
                  };
                case 'blue':
                  return {
                    bg: 'bg-blue-500',
                    ring: 'ring-blue-400',
                    text: 'text-blue-400'
                  };
                case 'cyan':
                  return {
                    bg: 'bg-cyan-500',
                    ring: 'ring-cyan-400',
                    text: 'text-cyan-400'
                  };
                case 'yellow':
                  return {
                    bg: 'bg-yellow-500',
                    ring: 'ring-yellow-400',
                    text: 'text-yellow-400'
                  };
                case 'orange':
                  return {
                    bg: 'bg-orange-500',
                    ring: 'ring-orange-400',
                    text: 'text-orange-400'
                  };
                default:
                  return {
                    bg: 'bg-slate-500',
                    ring: 'ring-slate-400',
                    text: 'text-slate-400'
                  };
              }
            };

            return (
              <div>
                {/* En-tête du calendrier */}
                <div className={`text-center mb-3 ${text('text-slate-200', 'text-gray-800')} font-semibold text-xs`}>
                  {monthNames[currentMonth]} {currentYear}
                </div>

                {/* Grille du calendrier compacte */}
                <div className="grid grid-cols-7 gap-1">
                  {/* Jours de la semaine */}
                  {weekDays.map((day, index) => (
                    <div key={`weekday-${index}`} className={`text-center text-[10px] font-semibold ${subTextClasses} py-1`}>
                      {day}
                    </div>
                  ))}

                  {/* Jours vides avant le premier jour du mois */}
                  {Array.from({ length: startOffset }).map((_, index) => (
                    <div key={`empty-${index}`} className="aspect-square"></div>
                  ))}

                  {/* Jours du mois */}
                  {Array.from({ length: daysInMonth }).map((_, index) => {
                    const day = index + 1;
                    const dayEvents = eventsByDay[day] || [];
                    const hasEvents = dayEvents.length > 0;

                    return (
                      <div
                        key={`day-${day}`}
                        className={`aspect-square flex flex-col items-center justify-center rounded border transition-all ${
                          hasEvents
                            ? 'border-cyan-500/50 bg-cyan-500/10'
                            : `${border('border-slate-700', 'border-gray-300')} ${bg('bg-slate-800/30', 'bg-gray-100')}`
                        }`}
                      >
                        <div className={`text-[10px] ${hasEvents ? 'font-bold text-cyan-300' : text('text-slate-300', 'text-gray-700')}`}>
                          {day}
                        </div>
                        {hasEvents && dayEvents.length > 0 && (
                          <div className="flex gap-[2px] mt-[2px]">
                            {dayEvents.slice(0, 2).map((event, eventIndex) => {
                              const colorClasses = getColorClasses(event.color);
                              return (
                                <div
                                  key={`event-${day}-${eventIndex}`}
                                  className={`w-1 h-1 rounded-full ${colorClasses.bg}`}
                                  title={event.label}
                                ></div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })()}
          </div>
        </div>
        </div>

        {/* Timeline - 3/12 sur 27" (1/4), 1/2 sur iPad */}
        <div className="md:col-span-1 xl:col-span-3">
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 h-full flex flex-col`}>
          <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-3 flex items-center flex-shrink-0`}>
            <Clock className="w-4 h-4 mr-2 text-cyan-400" />
            Timeline
          </h3>
          <div className="flex-1 overflow-y-auto pr-1">
            <div className="relative pl-6">
          {(() => {
            const formatDate = (date: string) => new Date(date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const statut = details.statut;
            const hasDiagnosis = details.diagnosis !== null && details.diagnosis !== undefined;
            const hasQuotation = quotation !== null;
            const quotationApproved = quotation?.statut === 'approved';
            const isClosed = details.closedAt !== null;

            // Déterminer quelle étape est en cours selon une logique séquentielle stricte
            let currentStep = 1; // Par défaut, on est sur la demande (qui est toujours complétée)

            // Déterminer l'étape actuelle
            if (!hasDiagnosis) {
              currentStep = 2; // Diagnostic en attente
            } else if (!quotationApproved) {
              currentStep = 3; // Devis en attente ou en cours
            } else if (statut === 'in_collection') {
              currentStep = 4; // Collecte en cours
            } else if (statut === 'in_progress') {
              currentStep = 5; // Réception en cours
            } else if (statut === 'completed' && !isClosed) {
              currentStep = 6; // Clôture en attente
            } else if (isClosed) {
              currentStep = 7; // Tout est terminé
            }

            // Construire la timeline avec une logique cohérente
            const timeline = [
              // 1. Demande - toujours complétée
              {
                label: 'Demande',
                date: formatDate(details.createdAt),
                status: 'completed',
                icon: FileText
              },
              // 2. Diagnostic
              {
                label: 'Diagnostic',
                date: hasDiagnosis
                  ? formatDate(details.diagnosis.dateVisite)
                  : (details.request?.plannedVisitAt ? formatDate(details.request.plannedVisitAt) : 'À planifier'),
                status: hasDiagnosis ? 'completed' : (currentStep === 2 ? 'in_progress' : 'pending'),
                icon: Clipboard
              },
              // 3. Devis
              {
                label: 'Devis',
                date: hasQuotation ? formatDate(quotation.createdAt) : 'En attente',
                status: quotationApproved ? 'completed' : (currentStep === 3 ? 'in_progress' : (currentStep > 3 ? 'completed' : 'pending')),
                icon: FileSpreadsheet
              },
              // 4. Collecte
              {
                label: 'Collecte',
                date: details.request?.plannedVisitAt ? formatDate(details.request.plannedVisitAt) : 'À planifier',
                status: currentStep > 4 ? 'completed' : (currentStep === 4 ? 'in_progress' : 'pending'),
                icon: Truck
              },
              // 5. Réception
              {
                label: 'Réception',
                date: statut === 'completed' ? formatDate(details.updatedAt) : 'En cours',
                status: currentStep > 5 ? 'completed' : (currentStep === 5 ? 'in_progress' : 'pending'),
                icon: Package
              },
              // 6. Clôture
              {
                label: 'Clôture',
                date: isClosed ? formatDate(details.closedAt) : 'À venir',
                status: isClosed ? 'completed' : (currentStep === 6 ? 'in_progress' : 'pending'),
                icon: CheckCircle2
              }
            ];

            return (
              <div className="relative">
                {/* Vertical line */}
                <div className={`absolute left-0 top-0 bottom-0 w-[2px] ${bg('bg-slate-700', 'bg-gray-300')}`}></div>

                {/* Timeline steps - vertical layout */}
                <div className="space-y-8">
                  {timeline.map((step, index) => {
                    const previousStepCompleted = index > 0 && timeline[index - 1].status === 'completed';
                    const showColoredLine = previousStepCompleted && (step.status === 'completed' || step.status === 'in_progress');

                    return (
                    <div key={index} className="relative group">
                      {/* Colored line segment - only if previous step completed */}
                      {index > 0 && showColoredLine && (
                        <div
                          className={`absolute left-0 w-[2px] transition-all duration-500 ${
                            step.status === 'completed'
                              ? 'bg-emerald-500'
                              : 'bg-cyan-500'
                          }`}
                          style={{
                            top: '-2rem',
                            height: '2rem'
                          }}
                        ></div>
                      )}

                      {/* Step node */}
                      <div className="flex items-start">
                        {/* Circle indicator */}
                        <div className="relative -left-[17px] z-10">
                          <div
                            className={`w-10 h-10 rounded-full flex items-center justify-center border-3 transition-all duration-300 ${
                              step.status === 'completed'
                                ? 'bg-emerald-500 border-emerald-400'
                                : step.status === 'in_progress'
                                ? 'bg-cyan-500 border-cyan-400 animate-pulse'
                                : `${bg('bg-slate-800', 'bg-gray-200')} ${border('border-slate-600', 'border-gray-400')}`
                            }`}
                          >
                            <step.icon
                              className={`w-5 h-5 ${
                                step.status === 'completed'
                                  ? 'text-white'
                                  : step.status === 'in_progress'
                                  ? 'text-white'
                                  : mutedTextClasses
                              }`}
                            />
                          </div>
                        </div>

                        {/* Step content */}
                        <div className="ml-6 flex-1 pb-2">
                          <div className="flex items-center justify-between mb-1">
                            <h4 className={`text-sm font-semibold ${
                              step.status === 'completed' || step.status === 'in_progress'
                                ? text('text-slate-200', 'text-gray-800')
                                : subTextClasses
                            }`}>
                              {step.label}
                            </h4>
                            {step.status === 'completed' && (
                              <CheckCircle2 className="w-4 h-4 text-emerald-400" />
                            )}
                            {step.status === 'in_progress' && (
                              <div className="flex items-center">
                                <div className="w-2 h-2 rounded-full bg-cyan-400 animate-ping mr-2"></div>
                                <span className="text-xs text-cyan-400 font-medium">En cours</span>
                              </div>
                            )}
                          </div>
                          <div className={`text-xs ${subTextClasses}`}>
                            {step.date}
                          </div>
                        </div>
                      </div>
                    </div>
                    );
                  })}
                </div>
              </div>
            );
          })()}
              </div>
            </div>
          </div>
        </div>
        </div>

        {/* Intervenants - 2/12 sur 27", full width below on iPad */}
        <div className="md:col-span-2 xl:col-span-2">
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 h-full flex flex-col`}>
          <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-3 flex items-center flex-shrink-0`}>
            <Users className="w-4 h-4 mr-2 text-cyan-400" />
            Intervenants
          </h3>
          <div className="flex-1 overflow-y-auto pr-1">
          {isLoadingUsers ? (
            <div className="flex items-center justify-center py-8">
              <div className={`text-xs ${subTextClasses}`}>Chargement...</div>
            </div>
          ) : users.length > 0 ? (
            <div className="space-y-3 overflow-y-auto flex-1 pr-2">
              {users.map((user) => {
                // Fonction pour obtenir l'icône et la couleur selon le rôle
                const getRoleInfo = (role: string) => {
                  switch (role.toLowerCase()) {
                    case 'admin':
                      return {
                        icon: Settings,
                        color: 'text-red-400',
                        bgColor: 'bg-red-500/10',
                        borderColor: 'border-red-500/30',
                        label: 'Direction'
                      };
                    case 'planificateur':
                      return {
                        icon: Calendar,
                        color: 'text-cyan-400',
                        bgColor: 'bg-cyan-500/10',
                        borderColor: 'border-cyan-500/30',
                        label: 'Planification'
                      };
                    case 'technicien':
                      return {
                        icon: FileEdit,
                        color: 'text-emerald-400',
                        bgColor: 'bg-emerald-500/10',
                        borderColor: 'border-emerald-500/30',
                        label: 'Manutention'
                      };
                    case 'logisticien':
                      return {
                        icon: Truck,
                        color: 'text-orange-400',
                        bgColor: 'bg-orange-500/10',
                        borderColor: 'border-orange-500/30',
                        label: 'Transport'
                      };
                    default:
                      return {
                        icon: Users,
                        color: 'text-slate-400',
                        bgColor: 'bg-slate-500/10',
                        borderColor: 'border-slate-500/30',
                        label: 'Autre'
                      };
                  }
                };

                const roleInfo = getRoleInfo(user.role);
                const RoleIcon = roleInfo.icon;

                // Créer les initiales pour l'avatar
                const initials = user.nom
                  .split(' ')
                  .map((n: string) => n[0])
                  .join('')
                  .toUpperCase()
                  .slice(0, 2);

                return (
                  <div
                    key={user.id}
                    className={`flex items-center p-3 ${roleInfo.bgColor} border ${roleInfo.borderColor} rounded-lg transition-all duration-300`}
                  >
                    {/* Avatar avec initiales */}
                    <div className={`w-10 h-10 rounded-full ${bg('bg-slate-700', 'bg-gray-300')} flex items-center justify-center mr-3 flex-shrink-0`}>
                      <span className={`text-xs font-semibold ${roleInfo.color}`}>
                        {initials}
                      </span>
                    </div>

                    {/* Info utilisateur */}
                    <div className="flex-1 min-w-0">
                      <div className={`text-sm font-medium ${text('text-slate-200', 'text-gray-800')} truncate`}>
                        {user.nom}
                      </div>
                      <div className="flex items-center gap-2 mt-0.5">
                        <RoleIcon className={`w-3 h-3 ${roleInfo.color}`} />
                        <span className={`text-xs ${subTextClasses}`}>
                          {roleInfo.label}
                        </span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-8">
              <Users className={`w-8 h-8 mx-auto mb-2 ${mutedTextClasses} opacity-20`} />
              <p className={`text-xs ${subTextClasses}`}>Aucun intervenant</p>
            </div>
          )}
          </div>
        </div>
        </div>

        {/* Prochaines Actions - 2/12 sur 27", full width below on iPad */}
        <div className="md:col-span-2 xl:col-span-2">
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 h-full flex flex-col`}>
            <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-3 flex items-center flex-shrink-0`}>
              <AlertCircle className="w-4 h-4 mr-2 text-cyan-400" />
              Actions
            </h3>
            <div className="flex-1 overflow-y-auto pr-1 space-y-2">
            {(() => {
              const statut = details.statut;
              const hasDiagnosis = details.diagnosis !== null;
              const hasQuotation = quotation !== null;
              const quotationApproved = quotation?.statut === 'approved';
              const isClosed = details.closedAt !== null;
              const lotsData = details.lots || [];
              const lotsSansPesee = lotsData.filter((lot: any) => !lot.poidsReel);

              // Utiliser la même logique que la timeline pour déterminer l'étape actuelle
              let currentStep = 1;
              if (!hasDiagnosis) {
                currentStep = 2;
              } else if (!quotationApproved) {
                currentStep = 3;
              } else if (statut === 'in_collection') {
                currentStep = 4;
              } else if (statut === 'in_progress') {
                currentStep = 5;
              } else if (statut === 'completed' && !isClosed) {
                currentStep = 6;
              } else if (isClosed) {
                currentStep = 7;
              }

              const actions = [];

              // Afficher l'action selon l'étape actuelle
              switch (currentStep) {
                case 2: // Diagnostic en attente
                  actions.push({
                    type: 'urgent',
                    icon: AlertCircle,
                    iconColor: 'text-red-400',
                    bgColor: 'bg-red-500/10',
                    borderColor: 'border-red-500/30',
                    title: 'Planifier visite de diagnostic',
                    description: details.request?.plannedVisitAt
                      ? `Visite prévue le ${new Date(details.request.plannedVisitAt).toLocaleDateString('fr-FR')}`
                      : 'Aucune date planifiée'
                  });
                  break;

                case 3: // Devis en attente
                  if (hasQuotation && quotation.statut === 'sent') {
                    const validiteDate = quotation.validiteAt
                      ? new Date(quotation.validiteAt).toLocaleDateString('fr-FR')
                      : 'Non définie';
                    actions.push({
                      type: 'info',
                      icon: Clock,
                      iconColor: 'text-cyan-400',
                      bgColor: 'bg-cyan-500/10',
                      borderColor: 'border-cyan-500/30',
                      title: 'Attente validation devis',
                      description: `Validité jusqu'au ${validiteDate}`
                    });
                  } else {
                    actions.push({
                      type: 'warning',
                      icon: FileSpreadsheet,
                      iconColor: 'text-yellow-400',
                      bgColor: 'bg-yellow-500/10',
                      borderColor: 'border-yellow-500/30',
                      title: 'Créer le devis',
                      description: `${nombreLots} lots identifiés - ${poidsEstime} kg estimé`
                    });
                  }
                  break;

                case 4: // Collecte en cours
                  actions.push({
                    type: 'info',
                    icon: Truck,
                    iconColor: 'text-cyan-400',
                    bgColor: 'bg-cyan-500/10',
                    borderColor: 'border-cyan-500/30',
                    title: 'Collecte en cours',
                    description: `Transport vers l'entrepôt - Site: ${details.request?.site?.nom || 'Non défini'}`
                  });
                  break;

                case 5: // Réception en cours
                  if (lotsSansPesee.length > 0) {
                    actions.push({
                      type: 'urgent',
                      icon: Weight,
                      iconColor: 'text-red-400',
                      bgColor: 'bg-red-500/10',
                      borderColor: 'border-red-500/30',
                      title: `Pesée manquante pour ${lotsSansPesee.length} lot${lotsSansPesee.length > 1 ? 's' : ''}`,
                      description: lotsSansPesee.map((l: any) => l.code).slice(0, 2).join(', ') + (lotsSansPesee.length > 2 ? '...' : '')
                    });
                  }
                  const lotsATraiter = lotsData.filter((lot: any) => lot.statut === 'pending');
                  if (lotsATraiter.length > 0) {
                    actions.push({
                      type: 'info',
                      icon: Package,
                      iconColor: 'text-cyan-400',
                      bgColor: 'bg-cyan-500/10',
                      borderColor: 'border-cyan-500/30',
                      title: `Traiter ${lotsATraiter.length} lot${lotsATraiter.length > 1 ? 's' : ''}`,
                      description: `Tri et orientation des matériels`
                    });
                  }
                  if (actions.length === 0) {
                    actions.push({
                      type: 'info',
                      icon: Package,
                      iconColor: 'text-cyan-400',
                      bgColor: 'bg-cyan-500/10',
                      borderColor: 'border-cyan-500/30',
                      title: 'Réception en cours',
                      description: `${lotsData.length} lot${lotsData.length > 1 ? 's' : ''} en traitement`
                    });
                  }
                  break;

                case 6: // Clôture en attente
                  actions.push({
                    type: 'warning',
                    icon: CheckCircle2,
                    iconColor: 'text-yellow-400',
                    bgColor: 'bg-yellow-500/10',
                    borderColor: 'border-yellow-500/30',
                    title: 'Prêt à clôturer',
                    description: 'Tous les traitements sont terminés'
                  });
                  break;

                case 7: // Dossier clôturé
                  actions.push({
                    type: 'success',
                    icon: CheckCircle2,
                    iconColor: 'text-emerald-400',
                    bgColor: 'bg-emerald-500/10',
                    borderColor: 'border-emerald-500/30',
                    title: 'Dossier clôturé',
                    description: details.closedAt
                      ? `Clôturé le ${new Date(details.closedAt).toLocaleDateString('fr-FR')}`
                      : 'Dossier terminé'
                  });
                  break;
              }

              return actions.map((action, index) => (
                <div key={index} className={`flex items-start p-2 ${action.bgColor} border ${action.borderColor} rounded-lg transition-all duration-300`}>
                  <action.icon className={`w-4 h-4 ${action.iconColor} mr-2 mt-0.5 flex-shrink-0`} />
                  <div className="flex-1 min-w-0">
                    <div className={`font-semibold text-xs ${text('text-slate-200', 'text-gray-800')}`}>{action.title}</div>
                    <div className={`text-[10px] ${subTextClasses} mt-0.5`}>{action.description}</div>
                  </div>
                </div>
              ));
            })()}
            </div>
        </div>
        </div>

        {/* Carte des Sites - 2/12 sur 27", full width below on iPad */}
        <div className="md:col-span-2 xl:col-span-2">
        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${border('border-slate-800', 'border-gray-200')} border rounded-xl p-4 h-full flex flex-col`}>
            <h3 className={`text-sm font-semibold ${text('text-slate-200', 'text-gray-800')} mb-3 flex items-center flex-shrink-0`}>
              <MapPin className="w-4 h-4 mr-2 text-cyan-400" />
              Site
            </h3>
            <div className={`flex-1 flex items-center justify-center ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded`}>
              <div className={`text-center ${mutedTextClasses}`}>
                <MapPin className="w-8 h-8 mx-auto mb-2 opacity-50" />
                <p className="text-xs">Carte interactive</p>
                <p className="text-[10px] mt-1">{details.request?.site?.nom || 'N/A'}</p>
              </div>
            </div>
        </div>
        </div>
      </div>
  );
  };

  const RequestDiagnosisTab = () => {
    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir les détails</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const request = details.request || {};
    const client = request.client || {};
    const site = request.site || {};
    const contact = request.contact || {};
    const diagnosis = details.diagnosis || null;
    const lotsData = details.lots || [];

    const formatDateTime = (dateString: string) => {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    const formatDuration = (minutes: number) => {
      if (!minutes) return '-';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}h ${mins}min`;
    };

    return (
      <div className="space-y-6">
        {/* Informations de la demande */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
            <FileText className="w-5 h-5 mr-2 text-blue-400" />
            Détails de la Demande
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Client</div>
              <div className={`${headingClasses} font-medium`}>{client.raisonSociale || 'Non renseigné'}</div>
              {client.siret && <div className={`text-xs ${subTextClasses} mt-1`}>SIRET: {client.siret}</div>}
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Site</div>
              <div className={`${headingClasses} font-medium`}>{site.nom || 'Non renseigné'}</div>
              {site.adresseComplete && <div className={`text-xs ${subTextClasses} mt-1`}>{site.adresseComplete}</div>}
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Contact</div>
              <div className={`${headingClasses} font-medium`}>
                {contact.nom || 'Non renseigné'}
                {contact.fonction && <span className={`${subTextClasses}`}> - {contact.fonction}</span>}
              </div>
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Téléphone / Email</div>
              <div className={`${headingClasses} font-medium`}>{contact.telephone || 'Non renseigné'}</div>
              {contact.email && <div className={`text-xs ${subTextClasses} mt-1`}>{contact.email}</div>}
            </div>
            <div className="md:col-span-2">
              <div className={`text-sm ${subTextClasses} mb-1`}>Description initiale</div>
              <div className={headingClasses}>
                {request.descriptionInitiale || 'Aucune description fournie'}
              </div>
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Catégorie principale</div>
              <div className={`${headingClasses} font-medium capitalize`}>{request.categoriePrincipale || 'Non définie'}</div>
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Volume estimé</div>
              <div className={`${headingClasses} font-medium`}>{request.volumeEstime || 'Non estimé'}</div>
            </div>
          </div>
        </div>

        {/* Fiche de visite diagnostic */}
        {diagnosis ? (
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
            <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
              <Clipboard className="w-5 h-5 mr-2 text-purple-400" />
              Fiche de Visite Diagnostic
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div className={`text-sm ${subTextClasses} mb-1`}>Technicien</div>
                <div className={`${headingClasses} font-medium`}>{diagnosis.technicienId || 'Non assigné'}</div>
              </div>
              <div>
                <div className={`text-sm ${subTextClasses} mb-1`}>Date de visite</div>
                <div className={`${headingClasses} font-medium`}>{formatDateTime(diagnosis.dateVisite)}</div>
              </div>
              <div>
                <div className={`text-sm ${subTextClasses} mb-1`}>Durée</div>
                <div className={`${headingClasses} font-medium`}>{formatDuration(diagnosis.dureeVisite)}</div>
              </div>
            </div>
            {diagnosis.notes && (
              <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-4`}>
                <div className={`text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>Notes du technicien:</div>
                <div className={`${subTextClasses} text-sm`}>
                  {diagnosis.notes}
                </div>
                <div className="mt-3 flex items-center text-sm">
                  <CheckCircle2 className="w-4 h-4 text-emerald-400 mr-2" />
                  <span className="text-emerald-400">Diagnostic complété</span>
                </div>
              </div>
            )}
          </div>
        ) : (
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
            <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
              <Clipboard className="w-5 h-5 mr-2 text-purple-400" />
              Fiche de Visite Diagnostic
            </h3>
            <div className="text-center py-8">
              <div className={`text-sm ${subTextClasses}`}>Aucun diagnostic effectué pour ce dossier</div>
            </div>
          </div>
        )}

        {/* Liste des lots diagnostiqués */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
            <Package className="w-5 h-5 mr-2 text-cyan-400" />
            Lots Diagnostiqués ({lotsData.length})
          </h3>
          {lotsData.length > 0 ? (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className={`border-b ${border('border-slate-700', 'border-gray-200')}`}>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Code Lot</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Catégorie</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Grade</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Orientation</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Poids Est. (kg)</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Poids Réel (kg)</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {lotsData.map((lot: any) => (
                    <tr key={lot.id} className={`border-b ${border('border-slate-700/50', 'border-gray-100')} ${bg('hover:bg-slate-700/30', 'hover:bg-gray-50')}`}>
                      <td className="py-3 px-4">
                        <div className={`font-medium ${headingClasses}`}>{lot.code}</div>
                        <div className={`text-xs ${subTextClasses}`}>{lot.qrCode}</div>
                      </td>
                      <td className={`py-3 px-4 ${text('text-slate-300', 'text-gray-700')}`}>{lot.categorieName || 'Non défini'}</td>
                      <td className="py-3 px-4">
                        <span className={`inline-block px-2 py-1 rounded text-xs font-medium border ${getGradeColor(lot.grade)}`}>
                          Grade {lot.grade}
                        </span>
                      </td>
                      <td className="py-3 px-4">
                        <span className={`text-sm ${text('text-slate-300', 'text-gray-700')} capitalize`}>{lot.orientation.replace('_', ' ')}</span>
                      </td>
                      <td className={`py-3 px-4 text-right ${headingClasses} font-medium`}>{lot.poidsEstime || 0}</td>
                      <td className="py-3 px-4 text-right">
                        {lot.poidsReel ? (
                          <span className="text-emerald-400 font-medium">{lot.poidsReel}</span>
                        ) : (
                          <span className={subTextClasses}>-</span>
                        )}
                      </td>
                      <td className="py-3 px-4">
                        <span className={`inline-block px-2 py-1 rounded text-xs font-medium border ${getStatusColor(lot.statut)}`}>
                          {lot.statut}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="text-center py-8">
              <div className={`text-sm ${subTextClasses}`}>Aucun lot diagnostiqué pour ce dossier</div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const QuotationTab = () => {
    const [isAddingLine, setIsAddingLine] = useState(false);
    const [editingLineId, setEditingLineId] = useState<string | null>(null);
    const [newLine, setNewLine] = useState({
      typeLigne: 'service',
      description: '',
      unite: 'forfait',
      quantite: 1,
      prixUnitaire: 0,
      tauxTVA: 20,
    });

    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir les détails</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const quotations = details.quotations || [];

    if (quotations.length === 0) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Aucun devis disponible pour ce dossier</div>
        </div>
      );
    }

    const quotation = quotations[0]; // Prendre le devis le plus récent
    const lines = quotation.lines || [];

    const handleAddLine = async (e: React.FormEvent) => {
      e.preventDefault();

      try {
        const response = await fetch(`http://localhost:5000/api/quotations/${quotation.id}/lines`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newLine),
        });

        const result = await response.json();

        if (result.success) {
          // Réinitialiser le formulaire
          setNewLine({
            typeLigne: 'service',
            description: '',
            unite: 'forfait',
            quantite: 1,
            prixUnitaire: 0,
            tauxTVA: 20,
          });
          setIsAddingLine(false);

          // Recharger les détails du dossier
          loadCaseFileDetails();
        } else {
          alert('Erreur lors de l\'ajout de la ligne: ' + result.error);
        }
      } catch (error) {
        console.error('Erreur lors de l\'ajout de la ligne:', error);
        alert('Erreur lors de l\'ajout de la ligne');
      }
    };

    const handleUpdateLine = async (e: React.FormEvent) => {
      e.preventDefault();

      if (!editingLineId) return;

      try {
        const response = await fetch(`http://localhost:5000/api/quotations/${quotation.id}/lines/${editingLineId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newLine),
        });

        const result = await response.json();

        if (result.success) {
          // Réinitialiser le formulaire
          setNewLine({
            typeLigne: 'service',
            description: '',
            unite: 'forfait',
            quantite: 1,
            prixUnitaire: 0,
            tauxTVA: 20,
          });
          setEditingLineId(null);
          setIsAddingLine(false);

          // Recharger les détails du dossier
          loadCaseFileDetails();
        } else {
          alert('Erreur lors de la mise à jour de la ligne: ' + result.error);
        }
      } catch (error) {
        console.error('Erreur lors de la mise à jour de la ligne:', error);
        alert('Erreur lors de la mise à jour de la ligne');
      }
    };

    const handleDeleteLine = async (lineId: string, e?: React.MouseEvent) => {
      if (e) {
        e.stopPropagation();
      }

      if (!confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) {
        return;
      }

      try {
        const response = await fetch(`http://localhost:5000/api/quotations/${quotation.id}/lines/${lineId}`, {
          method: 'DELETE',
        });

        const result = await response.json();

        if (result.success) {
          // Recharger les détails du dossier
          loadCaseFileDetails();
        } else {
          alert('Erreur lors de la suppression de la ligne: ' + result.error);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression de la ligne:', error);
        alert('Erreur lors de la suppression de la ligne');
      }
    };

    const handleEditLine = (line: any) => {
      setEditingLineId(line.id);
      setNewLine({
        typeLigne: line.typeLigne,
        description: line.description,
        unite: line.unite,
        quantite: line.quantite,
        prixUnitaire: line.prixUnitaire,
        tauxTVA: line.tauxTVA,
      });
      setIsAddingLine(true);
    };

    const loadCaseFileDetails = async () => {
      if (!selectedCaseFile) return;

      try {
        const response = await fetch(`http://localhost:5000/api/case-files/${selectedCaseFile}`);
        const result = await response.json();

        if (result.success && result.data) {
          setSelectedCaseFileDetails(result.data);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des détails du dossier:', error);
      }
    };

    const totalHT = quotation.montantHT || 0;
    const totalTVA = quotation.montantTVA || 0;
    const totalTTC = quotation.montantTTC || 0;

    const getQuotationStatusColor = (status: string) => {
      switch (status) {
        case 'approved':
          return 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30';
        case 'sent':
          return 'bg-blue-500/20 text-blue-300 border-blue-500/30';
        case 'draft':
          return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
        case 'rejected':
          return 'bg-red-500/20 text-red-300 border-red-500/30';
        default:
          return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
      }
    };

    const getQuotationStatusLabel = (status: string) => {
      switch (status) {
        case 'approved':
          return 'Approuvé par client';
        case 'sent':
          return 'Envoyé au client';
        case 'draft':
          return 'Brouillon';
        case 'rejected':
          return 'Refusé';
        default:
          return status;
      }
    };

    const formatDate = (dateString: string) => {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleDateString('fr-FR');
    };

    return (
      <div className="space-y-6">
        {/* En-tête devis */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <div className="flex items-center justify-between mb-4">
            <h3 className={`text-lg font-semibold ${headingClasses} flex items-center`}>
              <FileSpreadsheet className="w-5 h-5 mr-2 text-emerald-400" />
              Devis {details.reference} - Version {quotation.version || 1}
            </h3>
            <div className="flex gap-2">
              <button className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center">
                <Download className="w-4 h-4 mr-2" />
                Générer PDF
              </button>
              <button className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition-colors">
                Envoyer
              </button>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Statut</div>
              <span className={`inline-block px-3 py-1 rounded-lg text-sm font-medium border ${getQuotationStatusColor(quotation.statut)}`}>
                {getQuotationStatusLabel(quotation.statut)}
              </span>
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Date de création</div>
              <div className={`${headingClasses} font-medium`}>{formatDate(quotation.createdAt)}</div>
            </div>
            <div>
              <div className={`text-sm ${subTextClasses} mb-1`}>Validité</div>
              <div className={`${headingClasses} font-medium`}>
                {quotation.validiteAt ? `Jusqu'au ${formatDate(quotation.validiteAt)}` : 'Non définie'}
              </div>
            </div>
          </div>
        </div>

        {/* Tableau des lignes */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <div className="flex items-center justify-between mb-4">
            <h3 className={`text-lg font-semibold ${headingClasses}`}>Lignes de Devis</h3>
            <button
              onClick={() => setIsAddingLine(true)}
              className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center"
            >
              <Plus className="w-4 h-4 mr-2" />
              Ajouter une ligne
            </button>
          </div>

          {/* Formulaire d'ajout/édition de ligne */}
          {isAddingLine && (
            <form onSubmit={editingLineId ? handleUpdateLine : handleAddLine} className={`mb-4 p-3 rounded-lg border ${border('border-slate-700', 'border-gray-200')} ${bg('bg-slate-700/30', 'bg-gray-50')}`}>
              <div className="flex items-end gap-2">
                <div className="w-32">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>Type</label>
                  <select
                    value={newLine.typeLigne}
                    onChange={(e) => setNewLine({ ...newLine, typeLigne: e.target.value })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  >
                    <option value="service">Service</option>
                    <option value="material">Matériel</option>
                    <option value="package">Forfait</option>
                  </select>
                </div>
                <div className="flex-1">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>Description</label>
                  <input
                    type="text"
                    value={newLine.description}
                    onChange={(e) => setNewLine({ ...newLine, description: e.target.value })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  />
                </div>
                <div className="w-28">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>Unité</label>
                  <select
                    value={newLine.unite}
                    onChange={(e) => setNewLine({ ...newLine, unite: e.target.value })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  >
                    <option value="forfait">Forfait</option>
                    <option value="heure">Heure</option>
                    <option value="jour">Jour</option>
                    <option value="unité">Unité</option>
                    <option value="kg">Kg</option>
                    <option value="tonne">Tonne</option>
                    <option value="m3">M³</option>
                    <option value="lot">Lot</option>
                  </select>
                </div>
                <div className="w-24">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>Qté</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newLine.quantite}
                    onChange={(e) => setNewLine({ ...newLine, quantite: parseFloat(e.target.value) || 0 })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  />
                </div>
                <div className="w-28">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>Prix U. (€)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newLine.prixUnitaire}
                    onChange={(e) => setNewLine({ ...newLine, prixUnitaire: parseFloat(e.target.value) || 0 })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  />
                </div>
                <div className="w-24">
                  <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>TVA (%)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newLine.tauxTVA}
                    onChange={(e) => setNewLine({ ...newLine, tauxTVA: parseFloat(e.target.value) || 20 })}
                    className={`w-full ${inputClasses} border rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    required
                  />
                </div>
                <div className="flex gap-1">
                  <button
                    type="submit"
                    className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors"
                    title={editingLineId ? "Mettre à jour" : "Ajouter"}
                  >
                    <Save className="w-4 h-4" />
                  </button>
                  <button
                    type="button"
                    onClick={() => {
                      setIsAddingLine(false);
                      setEditingLineId(null);
                      setNewLine({
                        typeLigne: 'service',
                        description: '',
                        unite: 'forfait',
                        quantite: 1,
                        prixUnitaire: 0,
                        tauxTVA: 20,
                      });
                    }}
                    className={`px-3 py-1.5 rounded text-sm font-medium transition-colors ${bg('bg-slate-700', 'bg-gray-200')} ${text('text-slate-300', 'text-gray-700')} ${bg('hover:bg-slate-600', 'hover:bg-gray-300')}`}
                    title="Annuler"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              </div>
            </form>
          )}

          {lines.length > 0 ? (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className={`border-b ${border('border-slate-700', 'border-gray-200')}`}>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Type</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Description</th>
                    <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Unité</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Quantité</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Prix Unit.</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>TVA</th>
                    <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Total HT</th>
                    <th className={`text-center py-3 px-4 text-sm font-medium ${subTextClasses}`}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {lines.map((line: any) => {
                    const lineTotal = (line.quantite || 0) * (line.prixUnitaire || 0);
                    const isEditing = editingLineId === line.id;
                    return (
                      <tr
                        key={line.id}
                        onClick={() => handleEditLine(line)}
                        className={`border-b ${border('border-slate-700/50', 'border-gray-100')} ${bg('hover:bg-slate-700/30', 'hover:bg-gray-50')} cursor-pointer transition-colors ${isEditing ? bg('bg-blue-500/10', 'bg-blue-50') : ''}`}
                      >
                        <td className="py-2 px-3">
                          <span
                            className={`inline-block px-2 py-1 rounded text-xs font-medium ${
                              line.typeLigne === 'service'
                                ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30'
                                : line.typeLigne === 'material'
                                ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30'
                                : 'bg-cyan-500/20 text-cyan-300 border border-cyan-500/30'
                            }`}
                          >
                            {line.typeLigne === 'service' ? 'Service' : line.typeLigne === 'material' ? 'Matériel' : 'Forfait'}
                          </span>
                        </td>
                        <td className={`py-2 px-3 ${text('text-slate-300', 'text-gray-700')}`}>{line.description}</td>
                        <td className={`py-2 px-3 ${subTextClasses} text-sm`}>{line.unite}</td>
                        <td className={`py-2 px-3 text-right ${headingClasses} font-medium`}>{line.quantite}</td>
                        <td className={`py-2 px-3 text-right ${headingClasses}`}>{(line.prixUnitaire || 0).toFixed(2)} €</td>
                        <td className={`py-2 px-3 text-right ${subTextClasses} text-sm`}>{line.tauxTVA}%</td>
                        <td className="py-2 px-3 text-right text-emerald-400 font-medium">{lineTotal.toFixed(2)} €</td>
                        <td className="py-2 px-3 text-center">
                          <button
                            onClick={(e) => handleDeleteLine(line.id, e)}
                            className="inline-flex items-center justify-center w-7 h-7 rounded-lg hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-colors"
                            title="Supprimer cette ligne"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="text-center py-8">
              <div className={`text-sm ${subTextClasses}`}>Aucune ligne de devis</div>
            </div>
          )}
        </div>

        {/* Résumé financier */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4`}>Résumé Financier</h3>
          <div className="max-w-md ml-auto space-y-3">
            <div className="flex justify-between items-center pb-2">
              <span className={subTextClasses}>Total HT</span>
              <span className={`${headingClasses} font-medium text-lg`}>{totalHT.toFixed(2)} €</span>
            </div>
            <div className="flex justify-between items-center pb-2">
              <span className={subTextClasses}>TVA (20%)</span>
              <span className={`${headingClasses} font-medium text-lg`}>{totalTVA.toFixed(2)} €</span>
            </div>
            <div className={`flex justify-between items-center pt-3 border-t-2 ${border('border-slate-700', 'border-gray-300')}`}>
              <span className={`${headingClasses} font-semibold text-lg`}>Total TTC</span>
              <span className="text-emerald-400 font-bold text-2xl">{totalTTC.toFixed(2)} €</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const LogisticsTab = () => {
    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir les informations logistiques</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const request = details.request || {};
    const client = request.client || {};
    const site = request.site || {};
    const diagnosis = details.diagnosis || null;
    const lotsData = details.lots || [];
    const transportOrdersData = details.transportOrders || [];

    // Créer le planning des opérations basé sur les données réelles
    const operations = [];
    const formatDate = (dateString: string) => {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleDateString('fr-FR');
    };

    const formatTime = (dateString: string) => {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    };

    // 1. Demande créée (toujours complétée)
    operations.push({
      date: formatDate(details.createdAt),
      time: formatTime(details.createdAt),
      type: 'Demande d\'enlèvement créée',
      status: 'completed'
    });

    // 2. Visite diagnostic si planifiée ou effectuée
    if (request.plannedVisitAt) {
      const visitPassed = new Date(request.plannedVisitAt) < new Date();
      operations.push({
        date: formatDate(request.plannedVisitAt),
        time: formatTime(request.plannedVisitAt),
        type: 'Visite de diagnostic sur site',
        status: diagnosis ? 'completed' : (visitPassed ? 'in_progress' : 'planned')
      });
    }

    // 3. Enlèvement si le dossier est en cours de collecte ou après
    if (['in_collection', 'in_progress', 'completed'].includes(details.statut)) {
      operations.push({
        date: diagnosis ? formatDate(diagnosis.dateVisite) : '-',
        time: '09:00-12:00',
        type: 'Enlèvement site client',
        status: details.statut === 'in_collection' ? 'in_progress' : 'completed'
      });

      // 4. Transport vers entrepôt
      operations.push({
        date: diagnosis ? formatDate(diagnosis.dateVisite) : '-',
        time: '14:00-16:00',
        type: 'Transport vers entrepôt',
        status: ['in_progress', 'completed'].includes(details.statut) ? 'completed' : 'in_progress'
      });
    }

    // 5. Réception et pesée si en cours ou terminé
    if (['in_progress', 'completed'].includes(details.statut)) {
      operations.push({
        date: details.poidsReel ? formatDate(details.updatedAt) : '-',
        time: '10:00-11:00',
        type: 'Réception et pesée',
        status: details.poidsReel ? 'completed' : 'in_progress'
      });
    }

    // 6. Traitement des lots si applicable
    if (details.statut === 'completed' && lotsData.length > 0) {
      operations.push({
        date: formatDate(details.closedAt || details.updatedAt),
        time: '08:00-17:00',
        type: `Traitement des ${lotsData.length} lots`,
        status: 'completed'
      });
    }

    return (
      <div className="space-y-6">
        {/* Timeline des Sites */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-6 flex items-center`}>
            <MapPin className="w-5 h-5 mr-2 text-red-400" />
            Parcours Logistique
          </h3>

          <div className="relative">
            {/* Déterminer les étapes actives en fonction du statut et des lots */}
            {(() => {
              const activeSteps = {
                client: true, // Toujours présent
                warehouse: ['in_collection', 'in_progress', 'completed'].includes(details.statut),
                dismantling: lotsData.some((lot: any) => lot.orientation === 'dismantling'),
                physicalStore: lotsData.some((lot: any) => lot.orientation === 'resale'),
                ecommerce: lotsData.some((lot: any) => lot.orientation === 'resale' || lot.orientation === 'refurbishment'),
              };

              const activeStepsCount = Object.values(activeSteps).filter(Boolean).length;

              return (
                <>
                  {/* Ligne de timeline dynamique */}
                  <div className={`absolute top-12 left-8 right-8 h-0.5 ${bg('bg-slate-700', 'bg-gray-300')}`}></div>

                  {/* Sites - Grid dynamique */}
                  <div className={`grid grid-cols-1 md:grid-cols-${activeStepsCount} gap-4 relative`}>
              {/* Site Client (Enlèvement) */}
              <div className="flex flex-col items-center">
                <div className={`w-16 h-16 rounded-full ${bg('bg-blue-500/10', 'bg-blue-50')} ${border('border-blue-500/30', 'border-blue-200')} border-2 flex items-center justify-center mb-3 relative z-10`}>
                  <Building2 className="w-8 h-8 text-blue-400" />
                </div>
                <div className={`text-xs font-semibold ${headingClasses} mb-1 text-center`}>CLIENT</div>
                <div className={`text-xs ${subTextClasses} text-center mb-2`}>Enlèvement</div>
                <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-3 w-full`}>
                  <div className={`text-xs font-medium ${headingClasses} mb-1`}>{client.raisonSociale}</div>
                  <div className={`text-xs ${text('text-slate-400', 'text-gray-600')} leading-relaxed`}>{site.adresseComplete}</div>
                  {request.accessNotes && (
                    <div className={`text-xs ${text('text-slate-500', 'text-gray-500')} mt-2 italic`}>
                      Note: {request.accessNotes}
                    </div>
                  )}
                </div>
              </div>

                    {/* Entrepôt - Conditionnel */}
                    {activeSteps.warehouse && (
                      <div className="flex flex-col items-center">
                        <div className={`w-16 h-16 rounded-full ${bg('bg-purple-500/10', 'bg-purple-50')} ${border('border-purple-500/30', 'border-purple-200')} border-2 flex items-center justify-center mb-3 relative z-10`}>
                          <Package className="w-8 h-8 text-purple-400" />
                        </div>
                        <div className={`text-xs font-semibold ${headingClasses} mb-1 text-center`}>ENTREPÔT</div>
                        <div className={`text-xs ${subTextClasses} text-center mb-2`}>Stockage</div>
                        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-3 w-full`}>
                          <div className={`text-xs font-medium ${headingClasses} mb-1`}>D3E Valotik</div>
                          <div className={`text-xs ${text('text-slate-400', 'text-gray-600')} leading-relaxed`}>
                            Zone A - Allée 3<br/>
                            15 Rue de l'Industrie<br/>
                            75015 Paris
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Démantèlement - Conditionnel */}
                    {activeSteps.dismantling && (
                      <div className="flex flex-col items-center">
                        <div className={`w-16 h-16 rounded-full ${bg('bg-orange-500/10', 'bg-orange-50')} ${border('border-orange-500/30', 'border-orange-200')} border-2 flex items-center justify-center mb-3 relative z-10`}>
                          <Settings className="w-8 h-8 text-orange-400" />
                        </div>
                        <div className={`text-xs font-semibold ${headingClasses} mb-1 text-center`}>DÉMANTÈLEMENT</div>
                        <div className={`text-xs ${subTextClasses} text-center mb-2`}>Traitement</div>
                        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-3 w-full`}>
                          <div className={`text-xs font-medium ${headingClasses} mb-1`}>Atelier Recyclage</div>
                          <div className={`text-xs ${text('text-slate-400', 'text-gray-600')} leading-relaxed`}>
                            Bâtiment B<br/>
                            Zone Industrielle Nord<br/>
                            93400 Saint-Ouen
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Magasin Physique - Conditionnel */}
                    {activeSteps.physicalStore && (
                      <div className="flex flex-col items-center">
                        <div className={`w-16 h-16 rounded-full ${bg('bg-emerald-500/10', 'bg-emerald-50')} ${border('border-emerald-500/30', 'border-emerald-200')} border-2 flex items-center justify-center mb-3 relative z-10`}>
                          <Home className="w-8 h-8 text-emerald-400" />
                        </div>
                        <div className={`text-xs font-semibold ${headingClasses} mb-1 text-center`}>MAGASIN</div>
                        <div className={`text-xs ${subTextClasses} text-center mb-2`}>Vente Physique</div>
                        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-3 w-full`}>
                          <div className={`text-xs font-medium ${headingClasses} mb-1`}>Boutique SecondeTech</div>
                          <div className={`text-xs ${text('text-slate-400', 'text-gray-600')} leading-relaxed`}>
                            42 Avenue de la République<br/>
                            75011 Paris
                          </div>
                        </div>
                      </div>
                    )}

                    {/* E-Commerce - Conditionnel */}
                    {activeSteps.ecommerce && (
                      <div className="flex flex-col items-center">
                        <div className={`w-16 h-16 rounded-full ${bg('bg-cyan-500/10', 'bg-cyan-50')} ${border('border-cyan-500/30', 'border-cyan-200')} border-2 flex items-center justify-center mb-3 relative z-10`}>
                          <Monitor className="w-8 h-8 text-cyan-400" />
                        </div>
                        <div className={`text-xs font-semibold ${headingClasses} mb-1 text-center`}>E-COMMERCE</div>
                        <div className={`text-xs ${subTextClasses} text-center mb-2`}>Vente en Ligne</div>
                        <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-3 w-full`}>
                          <div className={`text-xs font-medium ${headingClasses} mb-1`}>Marketplace D3E</div>
                          <div className={`text-xs ${text('text-slate-400', 'text-gray-600')} leading-relaxed`}>
                            www.d3e-market.fr<br/>
                            Plateforme en ligne<br/>
                            24/7 Accessible
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Légende */}
                  <div className={`mt-6 pt-4 border-t ${border('border-slate-700', 'border-gray-200')}`}>
                    <div className="flex flex-wrap gap-4 justify-center">
                      {activeSteps.client && (
                        <div className="flex items-center gap-2">
                          <div className={`w-3 h-3 rounded-full bg-blue-500`}></div>
                          <span className={`text-xs ${subTextClasses}`}>Point d'enlèvement</span>
                        </div>
                      )}
                      {activeSteps.warehouse && (
                        <div className="flex items-center gap-2">
                          <div className={`w-3 h-3 rounded-full bg-purple-500`}></div>
                          <span className={`text-xs ${subTextClasses}`}>Stockage temporaire</span>
                        </div>
                      )}
                      {activeSteps.dismantling && (
                        <div className="flex items-center gap-2">
                          <div className={`w-3 h-3 rounded-full bg-orange-500`}></div>
                          <span className={`text-xs ${subTextClasses}`}>Traitement/Tri</span>
                        </div>
                      )}
                      {activeSteps.physicalStore && (
                        <div className="flex items-center gap-2">
                          <div className={`w-3 h-3 rounded-full bg-emerald-500`}></div>
                          <span className={`text-xs ${subTextClasses}`}>Distribution physique</span>
                        </div>
                      )}
                      {activeSteps.ecommerce && (
                        <div className="flex items-center gap-2">
                          <div className={`w-3 h-3 rounded-full bg-cyan-500`}></div>
                          <span className={`text-xs ${subTextClasses}`}>Distribution digitale</span>
                        </div>
                      )}
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        </div>

        {/* Planning des opérations */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
            <Calendar className="w-5 h-5 mr-2 text-blue-400" />
            Planning des Opérations
          </h3>
          <div className="space-y-3">
            {operations.map((operation, index) => (
              <div
                key={index}
                className={`flex items-center justify-between p-4 rounded-lg border ${
                  operation.status === 'completed'
                    ? `${bg('bg-emerald-500/10', 'bg-emerald-50')} ${border('border-emerald-500/30', 'border-emerald-200')}`
                    : operation.status === 'in_progress'
                    ? `${bg('bg-blue-500/10', 'bg-blue-50')} ${border('border-blue-500/30', 'border-blue-200')}`
                    : `${bg('bg-slate-700/30', 'bg-gray-100')} ${border('border-slate-600', 'border-gray-300')}`
                }`}
              >
                <div className="flex items-center gap-4">
                  <div className="text-center">
                    <div className={`text-sm ${subTextClasses}`}>Date</div>
                    <div className={`${headingClasses} font-medium`}>{operation.date}</div>
                  </div>
                  <div className="text-center">
                    <div className={`text-sm ${subTextClasses}`}>Horaire</div>
                    <div className={`${headingClasses} font-medium`}>{operation.time}</div>
                  </div>
                  <div className="ml-4">
                    <div className={`${headingClasses} font-medium`}>{operation.type}</div>
                  </div>
                </div>
                <div>
                  {operation.status === 'completed' && (
                    <CheckCircle2 className={`w-6 h-6 ${text('text-emerald-400', 'text-emerald-600')}`} />
                  )}
                  {operation.status === 'in_progress' && (
                    <Clock className={`w-6 h-6 ${text('text-blue-400', 'text-blue-600')} animate-pulse`} />
                  )}
                  {operation.status === 'planned' && (
                    <Calendar className={`w-6 h-6 ${subTextClasses}`} />
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Ordres de transport */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
            <Truck className="w-5 h-5 mr-2 text-purple-400" />
            Ordres de Transport
          </h3>
          {transportOrdersData.length > 0 ? (
            <div className="space-y-4">
              {transportOrdersData.map((order: any) => (
                <div key={order.id} className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-4`}>
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <div className={`font-medium ${headingClasses} text-lg`}>{order.type}</div>
                      <div className={`text-sm ${subTextClasses}`}>{order.id}</div>
                    </div>
                    <span className={`inline-block px-3 py-1 rounded-lg text-sm font-medium border ${getStatusColor(order.statut)}`}>
                      {getStatusLabel(order.statut)}
                    </span>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Transporteur</div>
                      <div className={`${headingClasses} font-medium`}>{order.transporteurName || 'Non assigné'}</div>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Véhicule</div>
                      <div className={`${headingClasses} font-medium`}>{order.vehicule || 'Non défini'}</div>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Conducteur</div>
                      <div className={`${headingClasses} font-medium`}>{order.conducteur || 'Non assigné'}</div>
                    </div>
                    <div>
                      <div className={`text-xs ${subTextClasses} mb-1`}>Date planifiée</div>
                      <div className={`${headingClasses} font-medium`}>{formatDate(order.datePlanifiee)}</div>
                    </div>
                  </div>
                  {order.documents && (
                    <div className={`mt-3 pt-3 border-t ${border('border-slate-700', 'border-gray-200')}`}>
                      <div className={`text-xs ${subTextClasses} mb-2`}>Documents</div>
                      <div className="flex gap-2">
                        {JSON.parse(order.documents || '[]').map((doc: string, i: number) => (
                          <span
                            key={i}
                            className={`inline-flex items-center px-2 py-1 ${bg('bg-slate-700', 'bg-gray-200')} rounded text-xs ${text('text-slate-300', 'text-gray-700')}`}
                          >
                            <FileText className="w-3 h-3 mr-1" />
                            {doc}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8">
              <Truck className={`w-12 h-12 mx-auto mb-2 opacity-30 ${subTextClasses}`} />
              <div className={`text-sm ${subTextClasses}`}>Aucun ordre de transport créé pour ce dossier</div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const InventoryTab = () => {
    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir l'inventaire</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const lotsData = details.lots || [];

    // Debug: afficher les données dans la console
    console.log('📦 Lots chargés:', lotsData);
    console.log('🔧 Composants du premier lot:', lotsData[0]?.components);

    if (lotsData.length === 0) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Aucun lot en stock pour ce dossier</div>
        </div>
      );
    }

    const formatDate = (dateString: string) => {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleDateString('fr-FR');
    };

    return (
    <div className="space-y-6">
      {/* Actions rapides */}
      <div className="flex gap-3">
        <button className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center">
          <QrCode className="w-4 h-4 mr-2" />
          Scanner QR Code
        </button>
        <button className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center">
          <Plus className="w-4 h-4 mr-2" />
          Générer Étiquettes
        </button>
      </div>

      {/* Tableau inventaire */}
      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
        <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
          <Package className="w-5 h-5 mr-2 text-purple-400" />
          Lots en Stock ({lotsData.length})
        </h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className={`border-b ${border('border-slate-700', 'border-gray-200')}`}>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>QR Code</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Code Lot</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Catégorie</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Grade</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Orientation</th>
                <th className={`text-right py-3 px-4 text-sm font-medium ${subTextClasses}`}>Poids (kg)</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Date Création</th>
                <th className={`text-left py-3 px-4 text-sm font-medium ${subTextClasses}`}>Statut</th>
                <th className={`text-center py-3 px-4 text-sm font-medium ${subTextClasses}`}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {lotsData.map((lot: any) => (
                <React.Fragment key={lot.id}>
                  {/* Ligne principale du lot */}
                  <tr
                    onClick={() => setExpandedLotId(expandedLotId === lot.id ? null : lot.id)}
                    className={`border-b ${border('border-slate-700/50', 'border-gray-100')} ${bg('hover:bg-slate-700/30', 'hover:bg-gray-50')} cursor-pointer transition-colors`}
                  >
                    <td className="py-3 px-4">
                      <div className="flex items-center">
                        <ChevronRight
                          className={`w-4 h-4 mr-2 ${subTextClasses} transition-transform ${expandedLotId === lot.id ? 'rotate-90' : ''}`}
                        />
                        <QrCode className={`w-4 h-4 mr-2 ${subTextClasses}`} />
                        <span className={`${text('text-slate-300', 'text-gray-700')} font-mono text-sm`}>{lot.qrCode}</span>
                      </div>
                    </td>
                    <td className="py-3 px-4">
                      <div className={`font-medium ${headingClasses}`}>{lot.code}</div>
                    </td>
                    <td className={`py-3 px-4 ${text('text-slate-300', 'text-gray-700')}`}>{lot.categorieName || 'Non défini'}</td>
                    <td className="py-3 px-4">
                      <span className={`inline-block px-2 py-1 rounded text-xs font-medium border ${getGradeColor(lot.grade)}`}>
                        Grade {lot.grade}
                      </span>
                    </td>
                    <td className="py-3 px-4">
                      <span className={`text-sm ${text('text-slate-300', 'text-gray-700')} capitalize`}>{lot.orientation.replace('_', ' ')}</span>
                    </td>
                    <td className={`py-3 px-4 text-right ${headingClasses} font-medium`}>
                      {lot.poidsReel || lot.poidsEstime || 0}
                    </td>
                    <td className={`py-3 px-4 ${text('text-slate-300', 'text-gray-700')}`}>{formatDate(lot.createdAt)}</td>
                    <td className="py-3 px-4">
                      <span className={`inline-block px-2 py-1 rounded text-xs font-medium border ${getStatusColor(lot.statut)}`}>
                        {lot.statut}
                      </span>
                    </td>
                    <td className="py-3 px-4">
                      <div className="flex justify-center gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setSelectedLotForDismantling(lot);
                            setIsDismantlingPanelOpen(true);
                          }}
                          className="px-3 py-1.5 rounded-lg bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-700 hover:to-purple-600 text-white text-xs font-medium transition-all shadow-md shadow-purple-500/30 flex items-center gap-1.5"
                          title="Démanteler le lot"
                        >
                          <Split className="w-3.5 h-3.5" />
                          ÉCLATER
                        </button>
                        <span className={`text-xs ${subTextClasses} flex items-center`}>
                          {lot.components?.length || 0} composants
                        </span>
                      </div>
                    </td>
                  </tr>

                  {/* Accordéon des composants */}
                  {expandedLotId === lot.id && (
                    <tr className={`${bg('bg-slate-800/50', 'bg-gray-50')}`}>
                      <td colSpan={9} className="p-0">
                        <div className="p-4 animate-slideDown">
                          <div className={`${bg('bg-slate-900', 'bg-white')} rounded-lg ${border('border-slate-700', 'border-gray-200')} border p-4`}>
                            <h4 className={`text-sm font-semibold ${headingClasses} mb-3 flex items-center`}>
                              <Package className="w-4 h-4 mr-2 text-purple-400" />
                              Composants du lot {lot.code}
                            </h4>
                            {lot.components && lot.components.length > 0 ? (
                              <div className="space-y-2">
                                {lot.components.map((component: any) => (
                                  <div
                                    key={component.id}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setSelectedComponent(component);
                                      setIsComponentPanelOpen(true);
                                    }}
                                    className={`flex items-center justify-between p-3 ${bg('bg-slate-800', 'bg-gray-50')} ${border('border-slate-700', 'border-gray-200')} border rounded-lg ${bg('hover:bg-slate-700', 'hover:bg-gray-100')} cursor-pointer transition-colors`}
                                  >
                                    <div className="flex items-center gap-4 flex-1">
                                      <div className={`w-10 h-10 rounded ${bg('bg-slate-700', 'bg-gray-200')} flex items-center justify-center`}>
                                        <FileEdit className={`w-5 h-5 ${subTextClasses}`} />
                                      </div>
                                      <div className="flex-1">
                                        <div className={`font-medium ${headingClasses} text-sm`}>
                                          {component.quantite > 1 && `${component.quantite}x `}
                                          {component.nom || component.categorieName}
                                        </div>
                                        <div className={`text-xs ${subTextClasses} mt-0.5`}>
                                          {component.subCategory && `${component.subCategory.category.nom} > ${component.subCategory.nom} • `}
                                          Grade: {component.grade} • {component.poidsUnitaire || component.poids}kg/u
                                        </div>
                                      </div>
                                    </div>
                                    <ChevronRight className={`w-4 h-4 ${subTextClasses}`} />
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className={`text-center py-8 ${subTextClasses} text-sm`}>
                                Aucun composant dans ce lot
                              </div>
                            )}
                          </div>
                        </div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );};

  const AnalyticsTab = () => {
    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir les analytics</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const lotsData = details.lots || [];

    if (lotsData.length === 0) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Aucune donnée analytique disponible (pas de lots)</div>
        </div>
      );
    }

    // Calculs KPIs
    const poidsReel = details.poidsReel || 0;
    const poidsEstime = details.poidsEstime || 0;
    const ecartPesee = poidsEstime > 0 ? (((poidsReel - poidsEstime) / poidsEstime) * 100).toFixed(1) : '0';

    const dateCreation = new Date(details.createdAt);
    const dateActuelle = details.closedAt ? new Date(details.closedAt) : new Date();
    const tempsCycle = Math.ceil((dateActuelle.getTime() - dateCreation.getTime()) / (1000 * 60 * 60 * 24));

    const lotsValorises = lotsData.filter((l: any) => ['resale', 'refurbishment'].includes(l.orientation)).length;
    const tauxValorisation = lotsData.length > 0 ? ((lotsValorises / lotsData.length) * 100).toFixed(1) : '0';

    return (
    <div className="space-y-6">
      {/* KPIs Analytiques */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-sm ${subTextClasses}`}>Taux de Valorisation</div>
            <TrendingUp className="w-5 h-5 text-emerald-400" />
          </div>
          <div className={`text-2xl font-bold ${headingClasses}`}>{tauxValorisation}%</div>
          <div className={`text-xs ${subTextClasses} mt-1`}>{lotsValorises} lots sur {lotsData.length}</div>
        </div>

        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-sm ${subTextClasses}`}>Temps de Cycle</div>
            <Clock className="w-5 h-5 text-blue-400" />
          </div>
          <div className={`text-2xl font-bold ${headingClasses}`}>{tempsCycle} jours</div>
          <div className={`text-xs ${subTextClasses} mt-1`}>Du {dateCreation.toLocaleDateString('fr-FR')}</div>
        </div>

        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-sm ${subTextClasses}`}>Écart Pesée</div>
            <Weight className="w-5 h-5 text-purple-400" />
          </div>
          <div className={`text-2xl font-bold ${
            Number(ecartPesee) > 0 ? 'text-emerald-400' : Number(ecartPesee) < 0 ? 'text-red-400' : headingClasses
          }`}>
            {Number(ecartPesee) > 0 ? '+' : ''}{ecartPesee}%
          </div>
          <div className={`text-xs ${subTextClasses} mt-1`}>Réel vs estimé</div>
        </div>

        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-2">
            <div className={`text-sm ${subTextClasses}`}>Nombre de Lots</div>
            <Package className="w-5 h-5 text-cyan-400" />
          </div>
          <div className={`text-2xl font-bold ${headingClasses}`}>{lotsData.length}</div>
          <div className={`text-xs ${subTextClasses} mt-1`}>Lots diagnostiqués</div>
        </div>
      </div>

      {/* Graphique poids par catégorie */}
      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
        <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
          <BarChart3 className="w-5 h-5 mr-2 text-blue-400" />
          Répartition du Poids par Catégorie
        </h3>
        <div className="space-y-3">
          {(() => {
            // Calculer la répartition des poids par catégorie
            const categoryWeights: { [key: string]: number } = {};
            let totalWeight = 0;

            lotsData.forEach((lot: any) => {
              const weight = lot.poidsReel || lot.poidsEstime || 0;
              const category = lot.categorieName || 'Autres';
              categoryWeights[category] = (categoryWeights[category] || 0) + weight;
              totalWeight += weight;
            });

            const colors = ['bg-blue-500', 'bg-purple-500', 'bg-cyan-500', 'bg-emerald-500', 'bg-orange-500', 'bg-pink-500'];
            let colorIndex = 0;

            return Object.entries(categoryWeights)
              .sort(([, a], [, b]) => b - a) // Trier par poids décroissant
              .map(([category, weight], index) => {
                const percentage = totalWeight > 0 ? ((weight / totalWeight) * 100).toFixed(1) : '0';
                const color = colors[colorIndex % colors.length];
                colorIndex++;

                return (
                  <div key={index}>
                    <div className="flex items-center justify-between mb-2">
                      <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>{category}</span>
                      <span className={`text-sm ${headingClasses} font-medium`}>{(weight / 1000).toFixed(2)} kg ({percentage}%)</span>
                    </div>
                    <div className={`w-full ${bg('bg-slate-700', 'bg-gray-300')} rounded-full h-2`}>
                      <div
                        className={`${color} h-2 rounded-full transition-all duration-500`}
                        style={{ width: `${percentage}%` }}
                      ></div>
                    </div>
                  </div>
                );
              });
          })()}
        </div>
      </div>

      {/* Répartition par grade et orientation */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4`}>Répartition par Grade</h3>
          <div className="space-y-3">
            {(() => {
              // Calculer la répartition par grade
              const gradeCount: { [key: string]: number } = {};
              lotsData.forEach((lot: any) => {
                const grade = lot.grade || 'N/A';
                gradeCount[grade] = (gradeCount[grade] || 0) + 1;
              });

              const gradeColors: { [key: string]: string } = {
                'A': 'bg-emerald-500',
                'B': 'bg-blue-500',
                'C': 'bg-orange-500',
                'D': 'bg-red-500',
                'N/A': 'bg-gray-500'
              };

              return Object.entries(gradeCount)
                .sort(([a], [b]) => a.localeCompare(b)) // Trier alphabétiquement
                .map(([grade, count], index) => {
                  const percentage = lotsData.length > 0 ? ((count / lotsData.length) * 100).toFixed(1) : '0';
                  const color = gradeColors[grade] || 'bg-gray-500';

                  return (
                    <div key={index}>
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center">
                          <span className={`inline-block px-2 py-1 rounded text-xs font-medium mr-2 ${getGradeColor(grade)}`}>
                            Grade {grade}
                          </span>
                          <span className={`text-sm ${subTextClasses}`}>{count} lots</span>
                        </div>
                        <span className={`text-sm ${headingClasses} font-medium`}>{percentage}%</span>
                      </div>
                      <div className={`w-full ${bg('bg-slate-700', 'bg-gray-300')} rounded-full h-2`}>
                        <div
                          className={`${color} h-2 rounded-full transition-all duration-500`}
                          style={{ width: `${percentage}%` }}
                        ></div>
                      </div>
                    </div>
                  );
                });
            })()}
          </div>
        </div>

        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4`}>Répartition par Orientation</h3>
          <div className="space-y-3">
            {(() => {
              // Calculer la répartition par orientation
              const orientationCount: { [key: string]: number } = {};
              lotsData.forEach((lot: any) => {
                const orientation = lot.orientation || 'N/A';
                orientationCount[orientation] = (orientationCount[orientation] || 0) + 1;
              });

              const orientationLabels: { [key: string]: string } = {
                'resale': 'Revente',
                'refurbishment': 'Reconditionnement',
                'dismantling': 'Démantèlement',
                'waste': 'Déchet',
                'N/A': 'Non défini'
              };

              const orientationColors: { [key: string]: string } = {
                'resale': 'bg-emerald-500',
                'refurbishment': 'bg-blue-500',
                'dismantling': 'bg-purple-500',
                'waste': 'bg-red-500',
                'N/A': 'bg-gray-500'
              };

              return Object.entries(orientationCount)
                .sort(([, a], [, b]) => b - a) // Trier par nombre décroissant
                .map(([orientation, count], index) => {
                  const percentage = lotsData.length > 0 ? ((count / lotsData.length) * 100).toFixed(1) : '0';
                  const label = orientationLabels[orientation] || orientation;
                  const color = orientationColors[orientation] || 'bg-gray-500';

                  return (
                    <div key={index}>
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center">
                          <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>{label}</span>
                          <span className={`text-xs ${subTextClasses} ml-2`}>({count} lots)</span>
                        </div>
                        <span className={`text-sm ${headingClasses} font-medium`}>{percentage}%</span>
                      </div>
                      <div className={`w-full ${bg('bg-slate-700', 'bg-gray-300')} rounded-full h-2`}>
                        <div
                          className={`${color} h-2 rounded-full transition-all duration-500`}
                          style={{ width: `${percentage}%` }}
                        ></div>
                      </div>
                    </div>
                  );
                });
            })()}
          </div>
        </div>
      </div>

      {/* Comparaison temporelle */}
      <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
        <h3 className={`text-lg font-semibold ${headingClasses} mb-4`}>Comparaison Temporelle</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className={`text-sm ${subTextClasses} mb-2`}>Ce dossier</div>
            <div className={`text-2xl font-bold ${headingClasses}`}>
              {(() => {
                const poids = poidsReel > 0 ? poidsReel : poidsEstime;
                const poidsEnTonnes = (poids / 1000000).toFixed(2);
                return `${poidsEnTonnes} T`;
              })()}
            </div>
            <div className={`text-xs ${subTextClasses} mt-1`}>Poids {poidsReel > 0 ? 'réel' : 'estimé'}</div>
          </div>
          <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className={`text-sm ${subTextClasses} mb-2`}>Nombre de lots</div>
            <div className={`text-2xl font-bold ${headingClasses}`}>{lotsData.length}</div>
            <div className={`text-xs ${subTextClasses} mt-1`}>Lots diagnostiqués</div>
          </div>
          <div className={`${bg('bg-slate-900', 'bg-gray-50')} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className={`text-sm ${subTextClasses} mb-2`}>Valeur totale</div>
            <div className={`text-2xl font-bold ${headingClasses}`}>
              {new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(details.valeurTotale || 0)}
            </div>
            <div className={`text-xs ${subTextClasses} mt-1`}>Estimation</div>
          </div>
        </div>
      </div>
    </div>
  );
  };

  const MediasTab = () => {
    const [isUploading, setIsUploading] = React.useState(false);
    const [uploadProgress, setUploadProgress] = React.useState(0);
    const fileInputRef = React.useRef<HTMLInputElement>(null);

    if (!selectedCaseFileDetails) {
      return (
        <div className="flex items-center justify-center py-20">
          <div className={`text-sm ${subTextClasses}`}>Sélectionnez un dossier pour voir les médias</div>
        </div>
      );
    }

    const details = selectedCaseFileDetails;
    const documents = details.documents || [];

    // Fonction pour gérer l'upload de fichiers
    const handleFileUpload = async (files: FileList | null) => {
      if (!files || files.length === 0) return;

      setIsUploading(true);
      setUploadProgress(0);

      const formData = new FormData();
      formData.append('file', files[0]);

      try {
        const response = await fetch(`http://localhost:5000/api/case-files/${selectedCaseFile}/documents`, {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          // Recharger les détails du dossier pour afficher le nouveau document
          await loadCaseFileDetails(selectedCaseFile);
          setUploadProgress(100);
          setTimeout(() => {
            setIsUploading(false);
            setUploadProgress(0);
          }, 1000);
        } else {
          console.error('Erreur upload:', result.error);
          setIsUploading(false);
        }
      } catch (error) {
        console.error('Erreur lors de l\'upload:', error);
        setIsUploading(false);
      }
    };

    // Fonction pour visualiser un document
    const handleViewDocument = (doc: any) => {
      window.open(`http://localhost:5000${doc.url}`, '_blank');
    };

    // Fonction pour télécharger un document
    const handleDownloadDocument = (doc: any) => {
      const link = document.createElement('a');
      link.href = `http://localhost:5000${doc.url}`;
      link.download = doc.nomFichier;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Fonction pour supprimer un document
    const handleDeleteDocument = async (docId: string) => {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce document ?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/documents/${docId}`, {
          method: 'DELETE',
        });

        const result = await response.json();

        if (result.success) {
          // Recharger les détails du dossier
          await loadCaseFileDetails(selectedCaseFile);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
      }
    };

    // Fonction pour obtenir l'icône et la couleur selon le type de fichier
    const getFileIcon = (type: string) => {
      switch (type.toLowerCase()) {
        case 'devis':
        case 'pdf':
          return { icon: FileText, color: 'text-red-400', bgColor: bg('bg-red-500/10', 'bg-red-50'), borderColor: border('border-red-500/30', 'border-red-200') };
        case 'photo':
        case 'image':
          return { icon: FileImage, color: 'text-blue-400', bgColor: bg('bg-blue-500/10', 'bg-blue-50'), borderColor: border('border-blue-500/30', 'border-blue-200') };
        case 'bon_pesée':
        case 'certificat':
          return { icon: FileText, color: 'text-emerald-400', bgColor: bg('bg-emerald-500/10', 'bg-emerald-50'), borderColor: border('border-emerald-500/30', 'border-emerald-200') };
        default:
          return { icon: File, color: 'text-slate-400', bgColor: bg('bg-slate-500/10', 'bg-gray-50'), borderColor: border('border-slate-500/30', 'border-gray-200') };
      }
    };

    const formatFileSize = (bytes: number) => {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    };

    const formatDate = (dateString: string) => {
      return new Date(dateString).toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    return (
      <div className="space-y-6">
        {/* Statistiques en haut */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className="flex items-center justify-between mb-2">
              <div className={`text-sm ${subTextClasses}`}>Total documents</div>
              <File className="w-5 h-5 text-slate-400" />
            </div>
            <div className={`text-2xl font-bold ${headingClasses}`}>{documents.length}</div>
          </div>

          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className="flex items-center justify-between mb-2">
              <div className={`text-sm ${subTextClasses}`}>Photos</div>
              <FileImage className="w-5 h-5 text-blue-400" />
            </div>
            <div className={`text-2xl font-bold ${headingClasses}`}>
              {documents.filter((d: any) => d.type === 'photo').length}
            </div>
          </div>

          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className="flex items-center justify-between mb-2">
              <div className={`text-sm ${subTextClasses}`}>Devis</div>
              <FileText className="w-5 h-5 text-red-400" />
            </div>
            <div className={`text-2xl font-bold ${headingClasses}`}>
              {documents.filter((d: any) => d.type === 'devis').length}
            </div>
          </div>

          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-4`}>
            <div className="flex items-center justify-between mb-2">
              <div className={`text-sm ${subTextClasses}`}>Certificats</div>
              <FileText className="w-5 h-5 text-emerald-400" />
            </div>
            <div className={`text-2xl font-bold ${headingClasses}`}>
              {documents.filter((d: any) => d.type === 'certificat').length}
            </div>
          </div>
        </div>

        {/* Layout 2 colonnes: Upload à gauche, Liste à droite */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Zone d'upload - Gauche */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
            <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
              <Upload className="w-5 h-5 mr-2 text-blue-400" />
              Ajouter des documents
            </h3>
            <div
              className={`border-2 border-dashed ${border('border-slate-600', 'border-gray-300')} rounded-lg p-8 text-center ${bg('hover:bg-slate-800/50', 'hover:bg-gray-50')} transition-colors cursor-pointer`}
              onDragOver={(e) => { e.preventDefault(); }}
              onDrop={(e) => {
                e.preventDefault();
                handleFileUpload(e.dataTransfer.files);
              }}
              onClick={() => fileInputRef.current?.click()}
            >
              <input
                ref={fileInputRef}
                type="file"
                className="hidden"
                accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx"
                onChange={(e) => handleFileUpload(e.target.files)}
              />
              {isUploading ? (
                <>
                  <div className="w-12 h-12 mx-auto mb-4 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                  <p className={`${headingClasses} font-medium mb-2`}>Upload en cours...</p>
                  <div className="w-full max-w-xs mx-auto bg-slate-700 rounded-full h-2 mt-4">
                    <div className="bg-blue-600 h-2 rounded-full transition-all" style={{ width: `${uploadProgress}%` }}></div>
                  </div>
                </>
              ) : (
                <>
                  <Upload className={`w-12 h-12 mx-auto mb-4 ${subTextClasses}`} />
                  <p className={`${headingClasses} font-medium mb-2`}>Glissez-déposez vos fichiers ici</p>
                  <p className={`text-sm ${subTextClasses} mb-4`}>ou cliquez pour parcourir</p>
                  <button
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                    onClick={(e) => {
                      e.stopPropagation();
                      fileInputRef.current?.click();
                    }}
                  >
                    Parcourir les fichiers
                  </button>
                  <p className={`text-xs ${subTextClasses} mt-4`}>
                    PDF, Images (JPG, PNG), Documents (DOC, XLS) - Max 10 MB par fichier
                  </p>
                </>
              )}
            </div>
          </div>

          {/* Liste des documents - Droite */}
          <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6`}>
          <div className="flex items-center justify-between mb-4">
            <h3 className={`text-lg font-semibold ${headingClasses} flex items-center`}>
              <File className="w-5 h-5 mr-2 text-purple-400" />
              Documents ({documents.length})
            </h3>
            <div className="flex items-center gap-2">
              <select className={`custom-select px-3 py-1.5 ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg text-sm`}>
                <option value="all">Tous les types</option>
                <option value="devis">Devis</option>
                <option value="photo">Photos</option>
                <option value="bon_pesée">Bons de pesée</option>
                <option value="certificat">Certificats</option>
              </select>
            </div>
          </div>

          {documents.length > 0 ? (
            <div className="space-y-3">
              {documents.map((doc: any) => {
                const fileInfo = getFileIcon(doc.type);
                const FileIcon = fileInfo.icon;

                return (
                  <div
                    key={doc.id}
                    className={`flex items-center justify-between p-4 ${fileInfo.bgColor} border ${fileInfo.borderColor} rounded-lg ${bg('hover:bg-slate-700/30', 'hover:bg-gray-100')} transition-colors`}
                  >
                    <div className="flex items-center gap-4 flex-1">
                      {/* Icône du fichier */}
                      <div className={`w-12 h-12 rounded-lg ${bg('bg-slate-800', 'bg-white')} ${border('border-slate-700', 'border-gray-200')} border flex items-center justify-center flex-shrink-0`}>
                        <FileIcon className={`w-6 h-6 ${fileInfo.color}`} />
                      </div>

                      {/* Informations du fichier */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <h4 className={`font-medium ${headingClasses} truncate`}>{doc.nomFichier}</h4>
                          <span className={`px-2 py-0.5 rounded text-xs font-medium ${fileInfo.bgColor} ${fileInfo.color}`}>
                            {doc.type}
                          </span>
                        </div>
                        <div className="flex items-center gap-4 text-xs">
                          <span className={subTextClasses}>
                            {doc.taille ? formatFileSize(doc.taille) : 'N/A'}
                          </span>
                          <span className={subTextClasses}>•</span>
                          <span className={subTextClasses}>
                            {formatDate(doc.createdAt)}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* Actions */}
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => handleViewDocument(doc)}
                        className={`p-2 ${bg('bg-slate-700', 'bg-gray-200')} ${bg('hover:bg-slate-600', 'hover:bg-gray-300')} rounded-lg transition-colors`}
                        title="Voir"
                      >
                        <Eye className={`w-4 h-4 ${text('text-slate-300', 'text-gray-700')}`} />
                      </button>
                      <button
                        onClick={() => handleDownloadDocument(doc)}
                        className={`p-2 ${bg('bg-slate-700', 'bg-gray-200')} ${bg('hover:bg-slate-600', 'hover:bg-gray-300')} rounded-lg transition-colors`}
                        title="Télécharger"
                      >
                        <Download className={`w-4 h-4 ${text('text-slate-300', 'text-gray-700')}`} />
                      </button>
                      <button
                        onClick={() => handleDeleteDocument(doc.id)}
                        className={`p-2 ${bg('bg-red-500/10', 'bg-red-50')} ${bg('hover:bg-red-500/20', 'hover:bg-red-100')} rounded-lg transition-colors`}
                        title="Supprimer"
                      >
                        <Trash2 className="w-4 h-4 text-red-400" />
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12">
              <File className={`w-16 h-16 mx-auto mb-4 opacity-20 ${subTextClasses}`} />
              <p className={`${headingClasses} font-medium mb-2`}>Aucun document</p>
              <p className={`text-sm ${subTextClasses}`}>Ajoutez des documents en utilisant la zone d'upload ci-dessus</p>
            </div>
          )}
          </div>
        </div>

        {/* Documents PDF Générés Automatiquement */}
        <div className={`${cardBgClasses} ${cardBorderClasses} border rounded-lg p-6 shadow-lg transition-all duration-300 hover:shadow-cyan-500/10`}>
          <h3 className={`text-lg font-semibold ${headingClasses} mb-4 flex items-center`}>
            <FileText className="w-5 h-5 mr-2 text-cyan-400 animate-pulse" />
            Documents PDF Officiels
          </h3>
          {(() => {
            const quotation = details.quotation;
            // Collecter tous les documents PDF générés automatiquement
            const pdfDocuments = [];

            // 1. Bon de commande (si devis approuvé)
            if (quotation?.statut === 'approved') {
              pdfDocuments.push({
                id: 'bon-commande',
                type: 'Bon de commande',
                name: `BC_${details.reference}.pdf`,
                date: quotation.createdAt,
                icon: FileSpreadsheet,
                color: 'text-emerald-400',
                bgColor: bg('bg-emerald-500/10', 'bg-emerald-50'),
                borderColor: border('border-emerald-500/30', 'border-emerald-200'),
                size: '245 Ko',
                description: 'Document contractuel validé'
              });
            }

            // 2. Rapport de diagnostic (si diagnostic effectué)
            if (details.diagnosis) {
              pdfDocuments.push({
                id: 'rapport-diagnostic',
                type: 'Rapport de diagnostic',
                name: `DIAG_${details.reference}.pdf`,
                date: details.diagnosis.dateVisite,
                icon: Clipboard,
                color: 'text-blue-400',
                bgColor: bg('bg-blue-500/10', 'bg-blue-50'),
                borderColor: border('border-blue-500/30', 'border-blue-200'),
                size: '1.2 Mo',
                description: `${(details.lots || []).length} lots identifiés`
              });
            }

            // 3. Bon de livraison (si collecte effectuée)
            if (details.statut !== 'diagnostic_pending' && details.statut !== 'quotation_pending') {
              pdfDocuments.push({
                id: 'bon-livraison',
                type: 'Bon de livraison',
                name: `BL_${details.reference}.pdf`,
                date: details.request?.plannedVisitAt || details.updatedAt,
                icon: Truck,
                color: 'text-orange-400',
                bgColor: bg('bg-orange-500/10', 'bg-orange-50'),
                borderColor: border('border-orange-500/30', 'border-orange-200'),
                size: '180 Ko',
                description: 'Preuve de collecte'
              });
            }

            // 4. Certificat de traçabilité (si dossier clôturé)
            if (details.closedAt) {
              pdfDocuments.push({
                id: 'certificat-tracabilite',
                type: 'Certificat de traçabilité',
                name: `CERT_${details.reference}.pdf`,
                date: details.closedAt,
                icon: CheckCircle2,
                color: 'text-purple-400',
                bgColor: bg('bg-purple-500/10', 'bg-purple-50'),
                borderColor: border('border-purple-500/30', 'border-purple-200'),
                size: '520 Ko',
                description: 'Traçabilité complète DEEE'
              });
            }

            // 5. Devis (si existant)
            if (quotation) {
              pdfDocuments.push({
                id: 'devis',
                type: 'Devis',
                name: `DEVIS_${details.reference}.pdf`,
                date: quotation.createdAt,
                icon: FileSpreadsheet,
                color: quotation.statut === 'approved' ? 'text-emerald-400' : 'text-yellow-400',
                bgColor: quotation.statut === 'approved'
                  ? bg('bg-emerald-500/10', 'bg-emerald-50')
                  : bg('bg-yellow-500/10', 'bg-yellow-50'),
                borderColor: quotation.statut === 'approved'
                  ? border('border-emerald-500/30', 'border-emerald-200')
                  : border('border-yellow-500/30', 'border-yellow-200'),
                size: '320 Ko',
                description: quotation.statut === 'approved' ? 'Validé' : 'En attente de validation'
              });
            }

            if (pdfDocuments.length === 0) {
              return (
                <div className="text-center py-12">
                  <FileText className={`w-16 h-16 mx-auto mb-4 ${mutedTextClasses} opacity-20`} />
                  <p className={`text-sm ${subTextClasses}`}>Aucun document PDF officiel disponible</p>
                  <p className={`text-xs ${mutedTextClasses} mt-2`}>Les documents seront générés au fur et à mesure du traitement du dossier</p>
                </div>
              );
            }

            return (
              <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                {pdfDocuments.map((doc) => {
                  const DocIcon = doc.icon;

                  return (
                    <div
                      key={doc.id}
                      className={`${doc.bgColor} border ${doc.borderColor} rounded-lg p-4 transition-all duration-300 hover:scale-105 hover:shadow-lg group`}
                    >
                      {/* Header avec icône et type */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <div className={`w-10 h-10 rounded-lg ${bg('bg-slate-700', 'bg-white')} flex items-center justify-center`}>
                            <DocIcon className={`w-5 h-5 ${doc.color}`} />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`text-xs font-medium ${doc.color} uppercase tracking-wide`}>
                              {doc.type}
                            </div>
                            <div className={`text-xs ${mutedTextClasses} mt-0.5`}>
                              {formatDate(doc.date)}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Nom du fichier */}
                      <div className={`text-sm font-semibold ${headingClasses} mb-1 truncate`}>
                        {doc.name}
                      </div>

                      {/* Description */}
                      <div className={`text-xs ${subTextClasses} mb-3`}>
                        {doc.description}
                      </div>

                      {/* Footer avec taille et actions */}
                      <div className="flex items-center justify-between pt-3 border-t border-slate-700/30">
                        <span className={`text-xs ${mutedTextClasses}`}>
                          {doc.size}
                        </span>
                        <div className="flex items-center gap-2">
                          {/* Bouton Aperçu */}
                          <button
                            className={`p-1.5 rounded-lg ${bg('bg-slate-700/50', 'bg-gray-100')} ${text('text-slate-300', 'text-gray-700')} transition-all duration-200 hover:scale-110 ${text('hover:text-cyan-400', 'hover:text-cyan-600')}`}
                            title="Aperçu"
                          >
                            <Eye className="w-4 h-4" />
                          </button>
                          {/* Bouton Télécharger */}
                          <button
                            className={`p-1.5 rounded-lg ${bg('bg-slate-700/50', 'bg-gray-100')} ${text('text-slate-300', 'text-gray-700')} transition-all duration-200 hover:scale-110 ${text('hover:text-emerald-400', 'hover:text-emerald-600')}`}
                            title="Télécharger"
                          >
                            <Download className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          })()}
        </div>
      </div>
    );
  };

  // Rendu des onglets
  const renderTabContent = () => {
    switch (activeTab) {
      case 'dashboard':
        return <DashboardTab />;
      case 'synthesis':
        return <SynthesisTab />;
      case 'request':
        return <RequestDiagnosisTab />;
      case 'quotation':
        return <QuotationTab />;
      case 'logistics':
        return <LogisticsTab />;
      case 'inventory':
        return <InventoryTab />;
      case 'analytics':
        return <AnalyticsTab />;
      case 'medias':
        return <MediasTab />;
      default:
        return <DashboardTab />;
    }
  };

  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'synthesis', label: 'Synthèse', icon: Home },
    { id: 'request', label: 'Demande & Diagnostic', icon: Clipboard },
    { id: 'quotation', label: 'Devis', icon: FileSpreadsheet },
    { id: 'logistics', label: 'Logistique', icon: Truck },
    { id: 'inventory', label: 'Inventaire', icon: Package },
    { id: 'analytics', label: 'Analytics', icon: TrendingUp },
    { id: 'medias', label: 'Médias', icon: FileImage },
  ];

  const currentFile = caseFiles.find((f) => f.id === selectedCaseFile);

  // Fonction de filtrage et recherche des dossiers
  const filteredCaseFiles = caseFiles.filter((file) => {
    // Filtre par statut
    const matchesStatus = filterStatus === 'all' || file.status === filterStatus;

    // Recherche dans tous les champs de la carte
    const searchLower = searchTerm.toLowerCase();
    const matchesSearch = searchTerm === '' ||
      file.reference.toLowerCase().includes(searchLower) ||
      file.client.toLowerCase().includes(searchLower) ||
      file.site.toLowerCase().includes(searchLower) ||
      getStatusLabel(file.status).toLowerCase().includes(searchLower) ||
      file.createdAt.toLowerCase().includes(searchLower) ||
      (file.collectionDate && file.collectionDate.toLowerCase().includes(searchLower));

    return matchesStatus && matchesSearch;
  });

  return (
    <>
      <style>{`
        .sidebar-scroll::-webkit-scrollbar {
          width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
          background: ${isDark ? '#1e293b' : '#f1f5f9'};
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
          background: ${isDark ? '#475569' : '#cbd5e1'};
          border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
          background: ${isDark ? '#64748b' : '#94a3b8'};
        }

        /* Style personnalisé pour les selects */
        .custom-select {
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='${isDark ? '%23cbd5e1' : '%23374151'}' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 0.75rem center;
          padding-right: 2.5rem;
        }
        .custom-select option {
          background: ${isDark ? '#1e293b' : '#ffffff'};
          color: ${isDark ? '#ffffff' : '#111827'};
          padding: 8px;
        }

        /* Animations pour le panel */
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }

        .animate-slideInRight {
          animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
      `}</style>
      <div className={`min-h-screen ${bg('bg-slate-950', 'bg-gray-50')} ${text('text-slate-100', 'text-gray-900')} transition-colors duration-200`}>
        <div className="flex relative">
          {/* Sidebar */}
          <div
            className={`sidebar-scroll w-80 ${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-r h-screen overflow-y-auto`}
            style={{
              scrollbarWidth: 'thin',
              scrollbarColor: isDark ? '#475569 #1e293b' : '#cbd5e1 #f1f5f9',
            }}
          >
          <div className={`p-4 ${border('border-slate-800', 'border-gray-200')} border-b`}>
            <h1 className={`text-xl font-bold ${text('text-white', 'text-gray-900')} mb-4`}>D3E Collection</h1>
            <div className="relative">
              <Search className={`absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 ${text('text-slate-500', 'text-gray-400')}`} />
              <input
                type="text"
                placeholder="Rechercher un dossier..."
                className={`w-full ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-lg pl-10 pr-4 py-2 text-sm ${text('text-white', 'text-gray-900')} ${text('placeholder-slate-500', 'placeholder-gray-500')} focus:outline-none focus:ring-2 focus:ring-blue-500`}
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>
            <div className="mt-3 flex gap-2">
              <select
                className={`custom-select flex-1 ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-3 py-2 text-sm ${text('text-white', 'text-gray-900')} cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500`}
                value={filterStatus}
                onChange={(e) => setFilterStatus(e.target.value)}
              >
                <option value="all">Tous les statuts</option>
                <option value="diagnostic_pending">À diagnostiquer</option>
                <option value="quote_pending">Devis en attente</option>
                <option value="quote_approved">Devis approuvé</option>
                <option value="in_collection">En collecte</option>
                <option value="in_progress">En cours</option>
                <option value="completed">Terminé</option>
              </select>
              <button className={`p-2 ${bg('bg-slate-800', 'bg-gray-100')} ${border('border-slate-700', 'border-gray-300')} border rounded-lg ${bg('hover:bg-slate-700', 'hover:bg-gray-200')}`}>
                <Filter className={`w-4 h-4 ${text('text-slate-400', 'text-gray-600')}`} />
              </button>
            </div>

            {/* Bouton Créer une demande */}
            <button
              onClick={() => setIsRequestPanelOpen(true)}
              className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-2.5 px-4 text-sm font-medium transition-colors flex items-center justify-center gap-2"
            >
              <Plus className="w-4 h-4" />
              Créer une demande
            </button>
          </div>

          {/* Liste des dossiers */}
          <div className="p-2">
            {isLoadingCaseFiles ? (
              <div className="flex items-center justify-center py-8">
                <div className={`text-sm ${subTextClasses}`}>Chargement des dossiers...</div>
              </div>
            ) : filteredCaseFiles.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-8 px-4">
                <div className={`text-sm ${subTextClasses} text-center`}>
                  {searchTerm || filterStatus !== 'all'
                    ? 'Aucun dossier ne correspond aux critères de recherche'
                    : 'Aucun dossier trouvé'}
                </div>
                {(searchTerm || filterStatus !== 'all') && (
                  <button
                    onClick={() => {
                      setSearchTerm('');
                      setFilterStatus('all');
                    }}
                    className={`mt-3 text-xs ${text('text-blue-400', 'text-blue-600')} hover:underline`}
                  >
                    Réinitialiser les filtres
                  </button>
                )}
              </div>
            ) : (
              filteredCaseFiles.map((file) => (
              <button
                key={file.id}
                onClick={() => setSelectedCaseFile(file.id)}
                className={`w-full text-left p-3 mb-2 rounded-lg transition-colors ${
                  selectedCaseFile === file.id
                    ? 'bg-blue-600 text-white'
                    : isDark
                      ? 'bg-slate-800 hover:bg-slate-700 text-slate-300'
                      : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                }`}
              >
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <div className="font-medium">{file.reference}</div>
                    <div className="text-xs opacity-80 mt-1">{file.client}</div>
                  </div>
                  {file.notifications > 0 && (
                    <span className="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                      {file.notifications}
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-2 mb-2">
                  <span className={`text-xs px-2 py-1 rounded border ${getStatusColor(file.status)}`}>
                    {getStatusLabel(file.status)}
                  </span>
                  <AlertCircle className={`w-3 h-3 ${getPriorityColor(file.priority)}`} />
                </div>
                <div className="text-xs opacity-70">
                  <div className="flex justify-between">
                    <span>Créé: {file.createdAt}</span>
                    {file.collectionDate && <span>Collecte: {file.collectionDate}</span>}
                  </div>
                </div>
                <div className="flex items-center gap-4 text-xs mt-2 pt-2 border-t border-white/10">
                  <div className="flex items-center gap-1">
                    <Euro className="w-3 h-3 text-emerald-400" />
                    <span className="opacity-70">Est:</span>
                    <span className="font-medium">{(file.valeurEstimee || 0).toLocaleString()}€</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <TrendingUp className="w-3 h-3 text-cyan-400" />
                    <span className="opacity-70">Rev:</span>
                    <span className="font-medium">{(file.valeurRevente || 0).toLocaleString()}€</span>
                  </div>
                </div>
              </button>
              ))
            )}
          </div>
        </div>

        {/* Contenu principal */}
        <div className="flex-1 overflow-auto">
          {/* Header */}
          <div className={`${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-b p-4`}>
            <div className={`flex items-center text-sm ${text('text-slate-400', 'text-gray-500')} mb-3`}>
              <span>Clients</span>
              <ChevronRight className="w-4 h-4 mx-1" />
              <span>{currentFile?.client}</span>
              <ChevronRight className="w-4 h-4 mx-1" />
              <span>{currentFile?.site}</span>
              <ChevronRight className="w-4 h-4 mx-1" />
              <span className={`${text('text-white', 'text-gray-900')} font-medium`}>Dossier {currentFile?.reference}</span>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <h2 className={`text-2xl font-bold ${text('text-white', 'text-gray-900')}`}>{currentFile?.reference}</h2>
                <span className={`px-3 py-1 rounded-lg text-sm font-medium border ${getStatusColor(currentFile?.status || '')}`}>
                  {getStatusLabel(currentFile?.status || '')}
                </span>
                {currentFile && currentFile.notifications > 0 && (
                  <div className="flex items-center gap-2 px-3 py-1 bg-red-500/20 border border-red-500/30 rounded-lg">
                    <Bell className="w-4 h-4 text-red-400" />
                    <span className="text-sm text-red-400">{currentFile.notifications} alertes</span>
                  </div>
                )}
              </div>

              <div className="flex gap-2">
                <button className={`px-4 py-2 ${bg('bg-slate-800', 'bg-gray-100')} ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg text-sm font-medium transition-colors flex items-center`}>
                  <QrCode className="w-4 h-4 mr-2" />
                  Scanner
                </button>
                <button className={`px-4 py-2 ${bg('bg-slate-800', 'bg-gray-100')} ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg text-sm font-medium transition-colors flex items-center`}>
                  <Download className="w-4 h-4 mr-2" />
                  Rapport
                </button>
                {/* Bouton de switch de thème */}
                <button
                  onClick={cycleTheme}
                  className={`px-4 py-2 ${bg('bg-slate-800', 'bg-gray-100')} ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg text-sm font-medium transition-colors flex items-center group relative`}
                  title={`Mode: ${getThemeLabel()} - Cliquer pour changer`}
                >
                  <ThemeIcon className="w-4 h-4 mr-2" />
                  <span className="hidden sm:inline">{getThemeLabel()}</span>
                  {/* Tooltip */}
                  <span className={`absolute -bottom-10 left-1/2 -translate-x-1/2 px-2 py-1 ${bg('bg-slate-700', 'bg-gray-700')} text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10`}>
                    {themeMode === 'light' && 'Passer au mode Sombre'}
                    {themeMode === 'dark' && 'Passer au mode Auto'}
                    {themeMode === 'auto' && 'Passer au mode Clair'}
                  </span>
                </button>
                <button
                  onClick={() => setIsRequestPanelOpen(true)}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  Nouvelle Demande
                </button>
              </div>
            </div>
          </div>

          {/* Navigation onglets */}
          <div className={`${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-b px-4`}>
            <div className="flex gap-1">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`px-4 py-3 font-medium text-sm transition-colors flex items-center gap-2 border-b-2 ${
                    activeTab === tab.id
                      ? 'text-blue-600 border-blue-500'
                      : isDark
                        ? 'text-slate-400 border-transparent hover:text-slate-300'
                        : 'text-gray-600 border-transparent hover:text-gray-900'
                  }`}
                >
                  <tab.icon className="w-4 h-4" />
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* Contenu de l'onglet */}
          <div className="p-6">{renderTabContent()}</div>
        </div>

        {/* Panneau latéral droit - Formulaire de demande */}
        {isRequestPanelOpen && (
          <>
            {/* Overlay */}
            <div
              className="fixed inset-0 bg-black/50 z-40 animate-fadeIn"
              onClick={() => setIsRequestPanelOpen(false)}
              style={{
                animation: 'fadeIn 0.3s ease-out'
              }}
            ></div>

            {/* Panneau */}
            <div
              className={`fixed right-0 top-0 h-screen w-1/2 ${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-l z-50 overflow-y-auto shadow-2xl animate-slideInRight`}
              style={{
                animation: 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
              }}
            >
              {/* Header du panneau */}
              <div className={`sticky top-0 ${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-b p-6 z-10`}>
                <div className="flex items-center justify-between mb-2">
                  <h2 className={`text-2xl font-bold ${headingClasses} flex items-center`}>
                    <FileText className="w-6 h-6 mr-3 text-blue-400" />
                    Nouvelle Demande d'Enlèvement
                  </h2>
                  <button
                    onClick={() => setIsRequestPanelOpen(false)}
                    className={`p-2 ${bg('hover:bg-slate-800', 'hover:bg-gray-100')} rounded-lg transition-colors`}
                  >
                    <X className={`w-5 h-5 ${subTextClasses}`} />
                  </button>
                </div>
                <p className={`text-sm ${subTextClasses}`}>
                  Créer une nouvelle demande de collecte D3E
                </p>
              </div>

              {/* Formulaire */}
              <form onSubmit={handleSubmitRequest} className="p-6 space-y-6">
                {/* Section Client & Site */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 ${border('border-slate-800', 'border-gray-200')} border-b`}>
                    <Building2 className="w-5 h-5 text-blue-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Informations Client & Site</h3>
                  </div>

                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Nom du Client <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="text"
                      name="clientName"
                      value={formData.clientName}
                      onChange={handleInputChange}
                      required
                      className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                      placeholder="Ex: TechCorp Industries"
                    />
                  </div>

                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Nom du Site <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="text"
                      name="siteName"
                      value={formData.siteName}
                      onChange={handleInputChange}
                      required
                      className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                      placeholder="Ex: Siège Paris 15"
                    />
                  </div>

                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Adresse Complète <span className="text-red-400">*</span>
                    </label>
                    <textarea
                      name="siteAddress"
                      value={formData.siteAddress}
                      onChange={handleInputChange}
                      required
                      rows={2}
                      className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none`}
                      placeholder="15 Avenue de la République, 75015 Paris"
                    />
                  </div>
                </div>

                {/* Section Contact */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 border-b ${border('border-slate-800', 'border-gray-200')}`}>
                    <Users className="w-5 h-5 text-purple-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Contact sur Site</h3>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Nom Complet <span className="text-red-400">*</span>
                      </label>
                      <input
                        type="text"
                        name="contactName"
                        value={formData.contactName}
                        onChange={handleInputChange}
                        required
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        placeholder="Pierre Durand"
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Fonction
                      </label>
                      <input
                        type="text"
                        name="contactFunction"
                        value={formData.contactFunction}
                        onChange={handleInputChange}
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        placeholder="Responsable IT"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Téléphone <span className="text-red-400">*</span>
                      </label>
                      <div className="relative">
                        <Phone className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                        <input
                          type="tel"
                          name="contactPhone"
                          value={formData.contactPhone}
                          onChange={handleInputChange}
                          required
                          className="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="+33 1 23 45 67 89"
                        />
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Email <span className="text-red-400">*</span>
                      </label>
                      <div className="relative">
                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                        <input
                          type="email"
                          name="contactEmail"
                          value={formData.contactEmail}
                          onChange={handleInputChange}
                          required
                          className="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="p.durand@techcorp.fr"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                {/* Section Description */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 border-b ${border('border-slate-800', 'border-gray-200')}`}>
                    <Clipboard className="w-5 h-5 text-cyan-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Description de la Demande</h3>
                  </div>

                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Description Détaillée <span className="text-red-400">*</span>
                    </label>
                    <textarea
                      name="description"
                      value={formData.description}
                      onChange={handleInputChange}
                      required
                      rows={4}
                      className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none`}
                      placeholder="Ex: Enlèvement de matériel informatique : 50 unités centrales, 30 écrans LCD, serveurs et accessoires..."
                    />
                    <p className="text-xs text-slate-500 mt-1">
                      Décrivez le type et la quantité approximative de matériel
                    </p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Catégorie Principale
                      </label>
                      <select
                        name="mainCategory"
                        value={formData.mainCategory}
                        onChange={handleInputChange}
                        className={`custom-select w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer`}
                      >
                        <option value="">Sélectionnez une catégorie</option>
                        {categories.map((cat) => (
                          <option key={cat.id} value={cat.nom}>{cat.nom}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Volume Estimé
                      </label>
                      <input
                        type="text"
                        name="estimatedVolume"
                        value={formData.estimatedVolume}
                        onChange={handleInputChange}
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        placeholder="Ex: 3 palettes"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Valeur Estimée (€)
                      </label>
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        name="valeurEstimee"
                        value={formData.valeurEstimee}
                        onChange={handleInputChange}
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        placeholder="Ex: 5000"
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Valeur Revente (€)
                      </label>
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        name="valeurRevente"
                        value={formData.valeurRevente}
                        onChange={handleInputChange}
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                        placeholder="Ex: 3000"
                      />
                    </div>
                  </div>
                </div>

                {/* Section Planification */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 border-b ${border('border-slate-800', 'border-gray-200')}`}>
                    <Calendar className="w-5 h-5 text-emerald-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Planification</h3>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Date de Visite Souhaitée
                      </label>
                      <input
                        type="date"
                        name="plannedVisitDate"
                        value={formData.plannedVisitDate}
                        onChange={handleInputChange}
                        className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500`}
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                        Priorité
                      </label>
                      <select
                        name="priority"
                        value={formData.priority}
                        onChange={handleInputChange}
                        className={`custom-select w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer`}
                      >
                        <option value="low">🟢 Basse</option>
                        <option value="medium">🟡 Moyenne</option>
                        <option value="high">🔴 Haute</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Notes d'Accès
                    </label>
                    <textarea
                      name="accessNotes"
                      value={formData.accessNotes}
                      onChange={handleInputChange}
                      rows={2}
                      className={`w-full ${inputClasses} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none`}
                      placeholder="Ex: Accès par quai de chargement, badge nécessaire..."
                    />
                  </div>
                </div>

                {/* Boutons d'action */}
                <div className="flex gap-3 pt-4 border-t border-slate-800">
                  <button
                    type="button"
                    onClick={() => setIsRequestPanelOpen(false)}
                    className={`flex-1 px-4 py-3 ${bg('bg-slate-800', 'bg-gray-100')} ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg font-medium transition-colors`}
                  >
                    Annuler
                  </button>
                  <button
                    type="submit"
                    className="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                  >
                    <Save className="w-5 h-5" />
                    Enregistrer la Demande
                  </button>
                </div>
              </form>
            </div>
          </>
        )}

        {/* Panneau latéral droit - Édition de composant */}
        {isComponentPanelOpen && selectedComponent && (
          <>
            {/* Overlay */}
            <div
              className="fixed inset-0 bg-black/50 z-40 animate-fadeIn"
              onClick={() => setIsComponentPanelOpen(false)}
              style={{
                animation: 'fadeIn 0.3s ease-out'
              }}
            ></div>

            {/* Panneau */}
            <div
              className={`fixed right-0 top-0 h-screen w-1/2 ${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-l z-50 overflow-y-auto shadow-2xl animate-slideInRight`}
              style={{
                animation: 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
              }}
            >
              {/* Header du panneau */}
              <div className={`sticky top-0 ${bg('bg-slate-900', 'bg-white')} ${border('border-slate-800', 'border-gray-200')} border-b p-6 z-10`}>
                <div className="flex items-center justify-between mb-2">
                  <h2 className={`text-2xl font-bold ${headingClasses} flex items-center`}>
                    <FileEdit className="w-6 h-6 mr-3 text-purple-400" />
                    Édition du Composant
                  </h2>
                  <button
                    onClick={() => setIsComponentPanelOpen(false)}
                    className={`p-2 ${bg('hover:bg-slate-800', 'hover:bg-gray-100')} rounded-lg transition-colors`}
                  >
                    <X className={`w-5 h-5 ${subTextClasses}`} />
                  </button>
                </div>
                <p className={`text-sm ${subTextClasses}`}>
                  Modifier les informations du composant
                </p>
              </div>

              {/* Contenu */}
              <div className="p-6 space-y-6">
                {/* Informations du composant */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 ${border('border-slate-800', 'border-gray-200')} border-b`}>
                    <Package className="w-5 h-5 text-purple-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Informations Générales</h3>
                  </div>

                  {/* ID et QR Code (lecture seule) */}
                  <div className={`p-4 ${bg('bg-slate-800/50', 'bg-gray-50')} rounded-lg`}>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>
                          ID Composant
                        </label>
                        <div className={`text-sm ${text('text-slate-300', 'text-gray-700')} font-mono`}>
                          {selectedComponent.id}
                        </div>
                      </div>
                      <div>
                        <label className={`block text-xs font-medium ${subTextClasses} mb-1`}>
                          Code QR
                        </label>
                        <div className={`text-sm ${text('text-slate-300', 'text-gray-700')} font-mono flex items-center gap-2`}>
                          <QrCode className="w-4 h-4" />
                          {selectedComponent.qrCode}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Nom de l'équipement */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Nom de l'équipement <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="text"
                      value={selectedComponent.nom || selectedComponent.categorieName || ''}
                      onChange={(e) => setSelectedComponent({...selectedComponent, nom: e.target.value})}
                      className={`w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500`}
                      placeholder="Ex: PC Dell OptiPlex 7090, Écran HP 24..."
                    />
                  </div>

                  {/* Quantité */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Quantité <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="number"
                      min="1"
                      value={selectedComponent.quantite || 1}
                      onChange={(e) => setSelectedComponent({...selectedComponent, quantite: parseInt(e.target.value) || 1})}
                      className={`w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500`}
                      placeholder="1"
                    />
                  </div>

                  {/* Catégorie */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Catégorie <span className="text-red-400">*</span>
                    </label>
                    <select
                      value={selectedCategoryId}
                      onChange={(e) => {
                        setSelectedCategoryId(e.target.value);
                        setSelectedComponent({...selectedComponent, subCategoryId: ''});
                      }}
                      className={`custom-select w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer`}
                    >
                      <option value="">Sélectionnez une catégorie</option>
                      {categories.map((cat) => (
                        <option key={cat.id} value={cat.id}>{cat.nom}</option>
                      ))}
                    </select>
                  </div>

                  {/* Sous-catégorie */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Sous-catégorie <span className="text-red-400">*</span>
                    </label>
                    <select
                      value={selectedComponent.subCategoryId || ''}
                      onChange={(e) => setSelectedComponent({...selectedComponent, subCategoryId: e.target.value})}
                      className={`custom-select w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer`}
                      disabled={!selectedCategoryId || availableSubCategories.length === 0}
                    >
                      <option value="">Sélectionnez une sous-catégorie</option>
                      {availableSubCategories.map((subCat) => (
                        <option key={subCat.id} value={subCat.id}>{subCat.nom}</option>
                      ))}
                    </select>
                  </div>

                  {/* Grade */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Grade <span className="text-red-400">*</span>
                    </label>
                    <select
                      value={selectedComponent.grade}
                      onChange={(e) => setSelectedComponent({...selectedComponent, grade: e.target.value})}
                      className={`custom-select w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer`}
                    >
                      <option value="A">Grade A - Excellent état</option>
                      <option value="B">Grade B - Bon état</option>
                      <option value="C">Grade C - État moyen</option>
                      <option value="D">Grade D - Mauvais état</option>
                      <option value="HS">HS - Hors service</option>
                    </select>
                  </div>

                  {/* Poids unitaire */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Poids Unitaire (kg) <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={selectedComponent.poidsUnitaire || selectedComponent.poids || ''}
                      onChange={(e) => setSelectedComponent({...selectedComponent, poidsUnitaire: parseFloat(e.target.value) || 0})}
                      className={`w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500`}
                      placeholder="0.00"
                    />
                    <div className={`text-xs ${subTextClasses} mt-1`}>
                      Poids par unité (sera multiplié par la quantité)
                    </div>
                  </div>

                  {/* Valeur unitaire estimée */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Valeur Unitaire Estimée (€)
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={selectedComponent.valeurUnitaire || selectedComponent.valeurEstimee || ''}
                      onChange={(e) => setSelectedComponent({...selectedComponent, valeurUnitaire: parseFloat(e.target.value) || null})}
                      className={`w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500`}
                      placeholder="0.00"
                    />
                    <div className={`text-xs ${subTextClasses} mt-1`}>
                      Valeur par unité (sera multipliée par la quantité)
                    </div>
                  </div>

                  {/* Statut */}
                  <div>
                    <label className={`block text-sm font-medium ${text('text-slate-300', 'text-gray-700')} mb-2`}>
                      Statut <span className="text-red-400">*</span>
                    </label>
                    <select
                      value={selectedComponent.statut}
                      onChange={(e) => setSelectedComponent({...selectedComponent, statut: e.target.value})}
                      className={`custom-select w-full ${inputClasses} ${border('border-slate-700', 'border-gray-300')} border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer`}
                    >
                      <option value="extracted">Extrait</option>
                      <option value="tested">Testé</option>
                      <option value="graded">Gradé</option>
                      <option value="stored">Stocké</option>
                      <option value="sold">Vendu</option>
                      <option value="recycled">Recyclé</option>
                    </select>
                  </div>
                </div>

                {/* Informations supplémentaires */}
                <div className="space-y-4">
                  <div className={`flex items-center gap-2 pb-2 ${border('border-slate-800', 'border-gray-200')} border-b`}>
                    <Info className="w-5 h-5 text-blue-400" />
                    <h3 className={`text-lg font-semibold ${headingClasses}`}>Informations Complémentaires</h3>
                  </div>

                  <div className={`p-4 ${bg('bg-slate-800/50', 'bg-gray-50')} rounded-lg space-y-3`}>
                    <div className="flex justify-between">
                      <span className={`text-sm ${subTextClasses}`}>Date de création</span>
                      <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>
                        {new Date(selectedComponent.createdAt).toLocaleDateString('fr-FR')}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className={`text-sm ${subTextClasses}`}>Dernière modification</span>
                      <span className={`text-sm ${text('text-slate-300', 'text-gray-700')}`}>
                        {new Date(selectedComponent.updatedAt).toLocaleDateString('fr-FR')}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className={`text-sm ${subTextClasses}`}>ID du lot</span>
                      <span className={`text-sm ${text('text-slate-300', 'text-gray-700')} font-mono`}>
                        {selectedComponent.lotId}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Boutons d'action */}
                <div className={`flex gap-3 pt-4 ${border('border-slate-800', 'border-gray-200')} border-t`}>
                  <button
                    type="button"
                    onClick={() => setIsComponentPanelOpen(false)}
                    className={`flex-1 px-4 py-3 ${bg('bg-slate-800', 'bg-gray-100')} ${bg('hover:bg-slate-700', 'hover:bg-gray-200')} ${border('border-slate-700', 'border-gray-300')} border ${text('text-white', 'text-gray-900')} rounded-lg font-medium transition-colors`}
                  >
                    Annuler
                  </button>
                  <button
                    type="button"
                    onClick={async () => {
                      try {
                        const response = await fetch(`http://localhost:5000/api/components/${selectedComponent.id}`, {
                          method: 'PUT',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({
                            categorieName: selectedComponent.categorieName,
                            grade: selectedComponent.grade,
                            poids: selectedComponent.poids,
                            valeurEstimee: selectedComponent.valeurEstimee,
                            statut: selectedComponent.statut,
                          }),
                        });

                        const result = await response.json();

                        if (result.success) {
                          // Recharger les détails du dossier pour mettre à jour l'affichage
                          await loadCaseFileDetails(selectedCaseFile);
                          setIsComponentPanelOpen(false);
                        } else {
                          alert('Erreur lors de la mise à jour du composant');
                        }
                      } catch (error) {
                        console.error('Error updating component:', error);
                        alert('Erreur lors de la mise à jour du composant');
                      }
                    }}
                    className="flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                  >
                    <Save className="w-5 h-5" />
                    Enregistrer les Modifications
                  </button>
                </div>
              </div>
            </div>
          </>
        )}

      {/* Panneau de démantèlement */}
      <DismantlingPanel />
      </div>
    </div>
    </>
  );
};

export default D3ECollectionApp;
